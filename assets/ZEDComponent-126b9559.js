var $i=Object.defineProperty;var Qi=(r,t,e)=>t in r?$i(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var s=(r,t,e)=>(Qi(r,typeof t!="symbol"?t+"":t,e),e);import{j as Mt}from"./jsx-runtime-94f6e698.js";import{r as Y}from"./index-8db94870.js";import{P as N,T,G as Xi,a as Ae,V as g,M as xe,b as Yi,c as Ki,S as X,d as ue,e as ei,B as qi,A as $,E as $e,f as G,Q as W,g as Ji,h as ti,i as Et,j as he,k as en,U as ii,C as Be,l as tn,m as q,n as J,o as ze,p as nn,q as rn,r as an,s as sn,t as on,u as ln,v as cn,w as hn,x as dn,y as mn,z as un,D as zt,R as fn,F as qe,H as gn,I as pn,J as vn,K as we,L as bn,N as yn,O as K,W as L,X as An,Y as Tn,Z as wn,_ as Rn,$ as Cn,a0 as On,a1 as Ct,a2 as Ge,a3 as Mn,a4 as Ci,a5 as Se,a6 as Oi,a7 as et,a8 as En,a9 as xn,aa as Pn,ab as Mi,ac as Sn,ad as _n,ae as In,af as ae,ag as Fn,ah as Dn,ai as zn,aj as Ln}from"./glTFMaterialsCommonExtension-1bf2ca18.js";class Bn{get gpuFrameTimeCounter(){return this.engine.getGPUFrameTimeCounter()}get captureGPUFrameTime(){return this._captureGPUFrameTime}set captureGPUFrameTime(t){t!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=t,this.engine.captureGPUFrameTime(t))}get shaderCompilationTimeCounter(){return this._shaderCompilationTime}get captureShaderCompilationTime(){return this._captureShaderCompilationTime}set captureShaderCompilationTime(t){t!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=t,t?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add(()=>{this._shaderCompilationTime.fetchNewFrame(),this._shaderCompilationTime.beginMonitoring()}),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add(()=>{this._shaderCompilationTime.endMonitoring()})):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))}constructor(t){this.engine=t,this._captureGPUFrameTime=!1,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new N,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}dispose(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null}}class Nn{get activeMeshesEvaluationTimeCounter(){return this._activeMeshesEvaluationTime}get captureActiveMeshesEvaluationTime(){return this._captureActiveMeshesEvaluationTime}set captureActiveMeshesEvaluationTime(t){t!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=t,t?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add(()=>{T.StartPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.beginMonitoring()}),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add(()=>{T.EndPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.endMonitoring(!1)})):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))}get renderTargetsRenderTimeCounter(){return this._renderTargetsRenderTime}get captureRenderTargetsRenderTime(){return this._captureRenderTargetsRenderTime}set captureRenderTargetsRenderTime(t){t!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=t,t?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add(()=>{T.StartPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.beginMonitoring()}),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add(()=>{T.EndPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.endMonitoring(!1)})):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))}get particlesRenderTimeCounter(){return this._particlesRenderTime}get captureParticlesRenderTime(){return this._captureParticlesRenderTime}set captureParticlesRenderTime(t){t!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=t,t?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add(()=>{T.StartPerformanceCounter("Particles"),this._particlesRenderTime.beginMonitoring()}),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add(()=>{T.EndPerformanceCounter("Particles"),this._particlesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))}get spritesRenderTimeCounter(){return this._spritesRenderTime}get captureSpritesRenderTime(){return this._captureSpritesRenderTime}set captureSpritesRenderTime(t){t!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=t,this.scene.spriteManagers&&(t?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add(()=>{T.StartPerformanceCounter("Sprites"),this._spritesRenderTime.beginMonitoring()}),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add(()=>{T.EndPerformanceCounter("Sprites"),this._spritesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))}get physicsTimeCounter(){return this._physicsTime}get capturePhysicsTime(){return this._capturePhysicsTime}set capturePhysicsTime(t){t!==this._capturePhysicsTime&&this.scene.onBeforePhysicsObservable&&(this._capturePhysicsTime=t,t?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add(()=>{T.StartPerformanceCounter("Physics"),this._physicsTime.beginMonitoring()}),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add(()=>{T.EndPerformanceCounter("Physics"),this._physicsTime.endMonitoring()})):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null))}get animationsTimeCounter(){return this._animationsTime}get captureAnimationsTime(){return this._captureAnimationsTime}set captureAnimationsTime(t){t!==this._captureAnimationsTime&&(this._captureAnimationsTime=t,t?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add(()=>{this._animationsTime.endMonitoring()}):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))}get frameTimeCounter(){return this._frameTime}get captureFrameTime(){return this._captureFrameTime}set captureFrameTime(t){this._captureFrameTime=t}get interFrameTimeCounter(){return this._interFrameTime}get captureInterFrameTime(){return this._captureInterFrameTime}set captureInterFrameTime(t){this._captureInterFrameTime=t}get renderTimeCounter(){return this._renderTime}get captureRenderTime(){return this._captureRenderTime}set captureRenderTime(t){t!==this._captureRenderTime&&(this._captureRenderTime=t,t?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add(()=>{this._renderTime.beginMonitoring(),T.StartPerformanceCounter("Main render")}),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add(()=>{this._renderTime.endMonitoring(!1),T.EndPerformanceCounter("Main render")})):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))}get cameraRenderTimeCounter(){return this._cameraRenderTime}get captureCameraRenderTime(){return this._captureCameraRenderTime}set captureCameraRenderTime(t){t!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=t,t?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add(e=>{this._cameraRenderTime.beginMonitoring(),T.StartPerformanceCounter(`Rendering camera ${e.name}`)}),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add(e=>{this._cameraRenderTime.endMonitoring(!1),T.EndPerformanceCounter(`Rendering camera ${e.name}`)})):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))}get drawCallsCounter(){return this.scene.getEngine()._drawCalls}constructor(t){this.scene=t,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new N,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new N,this._captureFrameTime=!1,this._frameTime=new N,this._captureRenderTime=!1,this._renderTime=new N,this._captureInterFrameTime=!1,this._interFrameTime=new N,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new N,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new N,this._capturePhysicsTime=!1,this._physicsTime=new N,this._captureAnimationsTime=!1,this._animationsTime=new N,this._captureCameraRenderTime=!1,this._cameraRenderTime=new N,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=t.onBeforeAnimationsObservable.add(()=>{this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.fetchNewFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.fetchNewFrame(),this._captureFrameTime&&(T.StartPerformanceCounter("Scene rendering"),this._frameTime.beginMonitoring()),this._captureInterFrameTime&&this._interFrameTime.endMonitoring(),this._captureParticlesRenderTime&&this._particlesRenderTime.fetchNewFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.fetchNewFrame(),this._captureAnimationsTime&&this._animationsTime.beginMonitoring(),this._captureRenderTime&&this._renderTime.fetchNewFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.fetchNewFrame(),this.scene.getEngine()._drawCalls.fetchNewFrame()}),this._onAfterRenderObserver=t.onAfterRenderObservable.add(()=>{this._captureFrameTime&&(T.EndPerformanceCounter("Scene rendering"),this._frameTime.endMonitoring()),this._captureRenderTime&&this._renderTime.endMonitoring(!1),this._captureInterFrameTime&&this._interFrameTime.beginMonitoring(),this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.endFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.endFrame(),this._captureParticlesRenderTime&&this._particlesRenderTime.endFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.endFrame(),this._captureRenderTime&&this._renderTime.endFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.endFrame()})}dispose(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null}}async function Lt(r,t,e){if(typeof caches>"u")return;const i=`${window.location.origin}/${t}`,n=await caches.open(r),a=JSON.stringify(e),o=new Response(a,{headers:{"content-type":"application/json"}});await n.put(i,o),console.log(`${r} successfully saved`)}async function xt(r,t){var a;if(typeof caches>"u"||!await caches.has(r))return;const e=`${window.location.origin}/${t}`,n=await(await caches.open(r)).match(e);if(n&&((a=n.headers.get("content-type"))!=null&&a.includes("application/json"))){const o=await n.text();return console.log(`${r} successfully loaded`),JSON.parse(o)}}async function Hn(r){typeof caches>"u"||caches.delete(r).then(()=>{console.log(`${r} successfully deleted`)}).catch(t=>{console.error(`${r} deletion failed:`,t)})}function ni(r,t){(t==null||t>r.length)&&(t=r.length);for(var e=0,i=new Array(t);e<t;e++)i[e]=r[e];return i}function Un(r,t){if(r){if(typeof r=="string")return ni(r,t);var e=Object.prototype.toString.call(r).slice(8,-1);if(e==="Object"&&r.constructor&&(e=r.constructor.name),e==="Map"||e==="Set")return Array.from(r);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return ni(r,t)}}function Vn(r,t){var e=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!e){if(Array.isArray(r)||(e=Un(r))||t&&r&&typeof r.length=="number"){e&&(r=e);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(c){throw c},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,o=!1,l;return{s:function(){e=e.call(r)},n:function(){var c=e.next();return a=c.done,c},e:function(c){o=!0,l=c},f:function(){try{!a&&e.return!=null&&e.return()}finally{if(o)throw l}}}}function kn(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function ri(r,t){for(var e=0;e<t.length;e++){var i=t[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Wn(r,t,e){return t&&ri(r.prototype,t),e&&ri(r,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function jn(r,t,e){return t in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r}var ai=function(){function r(){kn(this,r),jn(this,"listeners",new Set),this.emit=this.emit.bind(this)}return Wn(r,[{key:"clear",value:function(){this.listeners.clear()}},{key:"add",value:function(e){var i=this;return this.listeners.add(e),function(){return i.remove(e)}}},{key:"remove",value:function(e){this.listeners.delete(e)}},{key:"emit",value:function(e){var i=Vn(this.listeners),n;try{for(i.s();!(n=i.n()).done;){var a=n.value;a(e)}}catch(o){i.e(o)}finally{i.f()}}}]),r}();function si(r,t){(t==null||t>r.length)&&(t=r.length);for(var e=0,i=new Array(t);e<t;e++)i[e]=r[e];return i}function Gn(r,t){if(r){if(typeof r=="string")return si(r,t);var e=Object.prototype.toString.call(r).slice(8,-1);if(e==="Object"&&r.constructor&&(e=r.constructor.name),e==="Map"||e==="Set")return Array.from(r);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return si(r,t)}}function Zn(r,t){var e=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!e){if(Array.isArray(r)||(e=Gn(r))||t&&r&&typeof r.length=="number"){e&&(r=e);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(c){throw c},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,o=!1,l;return{s:function(){e=e.call(r)},n:function(){var c=e.next();return a=c.done,c},e:function(c){o=!0,l=c},f:function(){try{!a&&e.return!=null&&e.return()}finally{if(o)throw l}}}}function $n(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function oi(r,t){for(var e=0;e<t.length;e++){var i=t[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Qn(r,t,e){return t&&oi(r.prototype,t),e&&oi(r,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function Pt(r,t,e){return t in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r}var Ei;Ei=Symbol.iterator;var Xn=function(){function r(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];$n(this,r),Pt(this,"onEntityAdded",new ai),Pt(this,"onEntityRemoved",new ai),Pt(this,"entityPositions",new Map),this.entities=t,this.add=this.add.bind(this),this.remove=this.remove.bind(this);for(var e=0;e<t.length;e++)this.entityPositions.set(t[e],e)}return Qn(r,[{key:Ei,value:function(){var e=this,i=this.entities.length,n={value:void 0,done:!1};return{next:function(){return n.value=e.entities[--i],n.done=i<0,n}}}},{key:"size",get:function(){return this.entities.length}},{key:"first",get:function(){return this.entities[0]}},{key:"has",value:function(e){return this.entityPositions.has(e)}},{key:"add",value:function(e){return e&&!this.has(e)&&(this.entities.push(e),this.entityPositions.set(e,this.entities.length-1),this.onEntityAdded.emit(e)),e}},{key:"remove",value:function(e){if(this.has(e)){this.onEntityRemoved.emit(e);var i=this.entityPositions.get(e);this.entityPositions.delete(e);var n=this.entities[this.entities.length-1];n!==e&&(this.entities[i]=n,this.entityPositions.set(n,i)),this.entities.pop()}return e}},{key:"clear",value:function(){var e=Zn(this),i;try{for(e.s();!(i=e.n()).done;){var n=i.value;this.remove(n)}}catch(a){e.e(a)}finally{e.f()}}}]),r}();function Bt(r,t){(t==null||t>r.length)&&(t=r.length);for(var e=0,i=new Array(t);e<t;e++)i[e]=r[e];return i}function Yn(r){if(Array.isArray(r))return Bt(r)}function Kn(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function xi(r,t){if(r){if(typeof r=="string")return Bt(r,t);var e=Object.prototype.toString.call(r).slice(8,-1);if(e==="Object"&&r.constructor&&(e=r.constructor.name),e==="Map"||e==="Set")return Array.from(r);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Bt(r,t)}}function qn(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Nt(r){return Yn(r)||Kn(r)||xi(r)||qn()}function Ht(r){"@babel/helpers - typeof";return Ht=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ht(r)}function tt(r,t){var e=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!e){if(Array.isArray(r)||(e=xi(r))||t&&r&&typeof r.length=="number"){e&&(r=e);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(c){throw c},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,o=!1,l;return{s:function(){e=e.call(r)},n:function(){var c=e.next();return a=c.done,c},e:function(c){o=!0,l=c},f:function(){try{!a&&e.return!=null&&e.return()}finally{if(o)throw l}}}}function Ie(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function li(r,t){for(var e=0;e<t.length;e++){var i=t[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Fe(r,t,e){return t&&li(r.prototype,t),e&&li(r,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function Ne(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Ut(r,t){return Ut=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(i,n){return i.__proto__=n,i},Ut(r,t)}function Qe(r,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(t&&t.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),t&&Ut(r,t)}function st(r){return st=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},st(r)}function Jn(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function er(r,t){if(t&&(typeof t=="object"||typeof t=="function"))return t;if(t!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ne(r)}function Xe(r){var t=Jn();return function(){var i=st(r),n;if(t){var a=st(this).constructor;n=Reflect.construct(i,arguments,a)}else n=i.apply(this,arguments);return er(this,n)}}function fe(r,t,e){return t in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r}var Pi=function(){function r(){Ie(this,r),fe(this,"cache",new Map)}return Fe(r,[{key:"get",value:function(e,i){var n=this.cache.get(e);return n===void 0&&(this.cache.set(e,i),n=i),n}}]),r}();function tr(r){for(var t=arguments.length,e=new Array(t>1?t-1:0),i=1;i<t;i++)e[i-1]=arguments[i];return e.every(function(n){return r[n]!==void 0})}function ir(r){for(var t=arguments.length,e=new Array(t>1?t-1:0),i=1;i<t;i++)e[i-1]=arguments[i];return e.every(function(n){return r[n]===void 0})}new Pi;var ci=function(t){return Nt(new Set(t.sort().filter(function(e){return!!e&&e!==""})))},nr=function(t){return{with:t.with!==void 0?ci(t.with):[],without:t.without!==void 0?ci(t.without):[]}},rr=new Pi,ar=function(t){var e=nr(t),i=JSON.stringify(e);return rr.get(i,e)},Si=function(r){Qe(e,r);var t=Xe(e);function e(){var i;Ie(this,e);for(var n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];return i=t.call.apply(t,[this].concat(a)),fe(Ne(i),"buckets",new Set),i}return Fe(e,[{key:"wants",value:function(n){return!0}},{key:"evaluate",value:function(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:n;if(this.wants(a)?this.add(n):this.remove(n),this.has(n)){var o=tt(this.buckets),l;try{for(o.s();!(l=o.n()).done;){var c=l.value;c.evaluate(n,a)}}catch(h){o.e(h)}finally{o.f()}}}},{key:"where",value:function(n){var a=this,o=this.entities.length,l=function(){var h;do h=a.entities[--o];while(h&&!n(h));return{value:h,done:o<0}};return fe({},Symbol.iterator,function(){return{next:l}})}},{key:"with",value:function(){return this.archetype.apply(this,arguments)}},{key:"without",value:function(){for(var n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];return this.archetype({without:a})}},{key:"archetype",value:function(n){if(typeof n=="function"){var a=tt(this.buckets),o;try{for(a.s();!(o=a.n()).done;){var l=o.value;if(l instanceof hi&&l.predicate===n)return l}}catch(x){a.e(x)}finally{a.f()}var c=new hi(this,n);return this.buckets.add(c),c}if(Ht(n)!=="object"){for(var h=arguments.length,m=new Array(h>1?h-1:0),d=1;d<h;d++)m[d-1]=arguments[d];return this.archetype({with:[n].concat(m)})}var f=ar(n),u=tt(this.buckets),v;try{for(u.s();!(v=u.n()).done;){var w=v.value;if(w instanceof di&&w.query===f)return w}}catch(x){u.e(x)}finally{u.f()}var C=new di(this,f);return this.buckets.add(C),C}}]),e}(Xn),_i=function(r){Qe(e,r);var t=Xe(e);function e(i){var n;return Ie(this,e),n=t.call(this),n.source=i,n}return Fe(e,[{key:"startUpdating",value:function(){var n=this;this.source.onEntityAdded.add(function(a){n.wants(a)&&n.add(a)}),this.source.onEntityRemoved.add(function(a){n.remove(a)}),this.update()}},{key:"update",value:function(){var n=tt(this.source),a;try{for(n.s();!(a=n.n()).done;){var o=a.value;this.evaluate(o)}}catch(l){n.e(l)}finally{n.f()}}}]),e}(Si),hi=function(r){Qe(e,r);var t=Xe(e);function e(i,n){var a;return Ie(this,e),a=t.call(this,i),a.source=i,a.predicate=n,a.startUpdating(),a}return Fe(e,[{key:"wants",value:function(n){return this.predicate(n)}}]),e}(_i),di=function(r){Qe(e,r);var t=Xe(e);function e(i,n){var a;return Ie(this,e),a=t.call(this,i),a.source=i,a.query=n,a.startUpdating(),a}return Fe(e,[{key:"wants",value:function(n){return tr.apply(void 0,[n].concat(Nt(this.query.with||[])))&&ir.apply(void 0,[n].concat(Nt(this.query.without||[])))}}]),e}(_i);function mi(r,t){var e=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);t&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),e.push.apply(e,i)}return e}function sr(r){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?mi(Object(e),!0).forEach(function(i){fe(r,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(e)):mi(Object(e)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(e,i))})}return r}var or=function(r){Qe(e,r);var t=Xe(e);function e(){var i,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return Ie(this,e),i=t.call(this,n),fe(Ne(i),"entityToId",new Map),fe(Ne(i),"idToEntity",new Map),fe(Ne(i),"nextId",0),i.onEntityRemoved.add(function(a){if(i.entityToId.has(a)){var o=i.entityToId.get(a);i.idToEntity.delete(o),i.entityToId.delete(a)}}),i}return Fe(e,[{key:"update",value:function(i){function n(a,o,l){return i.apply(this,arguments)}return n.toString=function(){return i.toString()},n}(function(i,n,a){if(typeof n=="function"){var o=n(i);o&&Object.assign(i,o)}else typeof n=="string"?i[n]=a:n&&Object.assign(i,n);return this.has(i)&&this.evaluate(i),i})},{key:"addComponent",value:function(n,a,o){n[a]===void 0&&(n[a]=o,this.has(n)&&this.evaluate(n))}},{key:"removeComponent",value:function(n,a){if(n[a]!==void 0){if(this.has(n)){var o=sr({},n);delete o[a],this.evaluate(n,o)}delete n[a]}}},{key:"id",value:function(n){if(this.has(n)){if(!this.entityToId.has(n)){var a=this.nextId++;this.entityToId.set(n,a),this.idToEntity.set(a,n)}return this.entityToId.get(n)}}},{key:"entity",value:function(n){return this.idToEntity.get(n)}}]),e}(Si);const p=new or,ui=r=>{const t=p.add({entityId:Xi.RandomId(),...r}),e=t.TransformNode;return e&&(e.metadata={...e.metadata,entity:t}),t},y=r=>{r.clear(),r.onEntityAdded.clear(),r.onEntityRemoved.clear()};class lr{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","TransformNode","GUIDisplayable"));s(this,"viewPort");s(this,"transformMatrix");s(this,"afterRenderExecute",t=>{const e=this.guiUpdate(t);z.instance.onUpdateGUIPosition.notifyObservers(e)});s(this,"guiUpdate",t=>{const e=t.activeCamera;if(e===null||!(e instanceof Ae))return;const i=t.getEngine(),n=i.getHardwareScalingLevel(),a=e.viewport.clone();if(a.y=1-a.y,this.viewPort=a.toGlobal(i.getRenderWidth()*n,i.getRenderHeight()*n),this.transformMatrix||(this.transformMatrix=t.getTransformMatrix()),this.viewPort&&this.transformMatrix){const o=this.getIconSize(e),l=this.transformMatrix,c=this.viewPort;return this.targetArchetype.entities.map(h=>{const m=h.TransformNode,d=g.Project(m.getAbsolutePosition(),xe.Identity(),l,c);return{key:h.entityId,name:m.name,x:d.x,y:d.y-c.height,iconSize:o,thingType:h.ThingState?h.ThingState.type:void 0,thingState:h.ThingState?h.ThingState.state:void 0}})??[]}return[]});s(this,"getIconSize",t=>{const e=t.radius,i=t.lowerRadiusLimit,n=t.upperRadiusLimit;if(i===null||n===null)return 1;{const a=n-i;return a===0?1:1-Math.min(1,(e-i)/a)}})}dispose(){y(this.targetArchetype)}}const ht=class{constructor(){s(this,"targetArchetype",p.with("Identifier","Reflector"));s(this,"floorplanArchetype",p.with("Identifier","Floorplan"));s(this,"reflectionTargetArchetype",p.with("Identifier","TransformNode","ReflectionTarget"));s(this,"reflectionTextureList",new Map);ht.instance=this,this.reflectionTargetArchetype.onEntityAdded.add(t=>this.initReflectionTarget(t)),this.floorplanArchetype.onEntityAdded.add(t=>this.initFloorplan(t))}static getReflectorEntities(){var t;return((t=this.instance)==null?void 0:t.getReflectors())??[]}static getReflectorsInFloorplan(t){var e;return((e=this.instance)==null?void 0:e.getReflectorsInFloorplan(t))??[]}static changeReflectorSettings(t,e,i){var n;(n=this.instance)==null||n.changeReflectorSettings(t,e,i)}static getReflectionTexture(t){var e;return((e=this.instance)==null?void 0:e.getReflectionTexture(t))??null}dispose(){ht.instance=void 0,this.reflectionTextureList.forEach(t=>t.dispose()),this.reflectionTextureList.clear(),y(this.targetArchetype),y(this.floorplanArchetype),y(this.reflectionTargetArchetype)}beforeRenderExecute(t){for(const e of this.targetArchetype.entities){const i=e.Reflector;if(i&&i.reflectionTexture.isReady()){const n=i.reflectionTexture;n.level!==i.level&&(n.level=i.level),n.adaptiveBlurKernel!==i.blurKernel&&(n.adaptiveBlurKernel=i.blurKernel,b.RenderUpdate())}}}initReflectionTarget(t){var a;p.removeComponent(t,"ReflectionTarget");const e=t.Identifier.floorplanId,i=t.TransformNode.getChildMeshes(),n=this.getReflectionTexture(e);n&&((a=n.renderList)==null||a.push(...i))}initFloorplan(t){const e=t.Identifier.floorplanId,i=this.getReflectionTexture(e);i&&(i.mirrorPlane=Yi.FromPositionAndNormal(t.Floorplan.pivotPosition,g.Up().scale(-1)),p.addComponent(t,"Reflector",{reflectionTexture:i,level:i.level,blurKernel:i.blurKernel}))}getReflectionTexture(t){if(!this.reflectionTextureList.has(t)){const e=new Ki("mirror",1024,void 0,!0);e.level=.1,e.adaptiveBlurKernel=40,e.renderList=[],this.reflectionTextureList.set(t,e)}return this.reflectionTextureList.get(t)}getReflectors(){return this.targetArchetype.entities??[]}getReflectorsInFloorplan(t){return this.targetArchetype.entities.filter(e=>e.Identifier.floorplanId===t)??[]}changeReflectorSettings(t,e,i){t.level=e,i>0&&(t.blurKernel=i),b.RenderUpdate()}};let ge=ht;s(ge,"instance");const Ii=r=>new g(-r.x,r.y,r.z),Fi=r=>-r,Vt=r=>new g(r.x,r.y,r.z),fi=r=>r*(Math.PI/180),Je=async r=>await new Promise((e,i)=>{const n=new XMLHttpRequest;n.open("GET",r),n.onload=a=>{e(JSON.parse(n.responseText))},n.onerror=a=>{i(a)},n.send()});function cr(r,t){const e=t[1].subtract(t[0]),i=t[2].subtract(t[0]),n=t[0].subtract(r),a=g.Dot(e,e),o=g.Dot(e,i),l=g.Dot(i,i),c=g.Dot(e,n),h=g.Dot(i,n),m=a*l-o*o;let d=o*h-l*c,f=o*c-a*h;if(d+f<m)if(d<0)f<0?c<0?(d=X.Clamp(-c/a,0,1),f=0):(d=0,f=X.Clamp(-h/l,0,1)):(d=0,f=X.Clamp(-h/l,0,1));else if(f<0)d=X.Clamp(-c/a,0,1),f=0;else{let u=1/m;d*=u,f*=u}else if(d<0){let u=o+c,v=l+h;if(v>u){const w=v-u,C=a-2*o+l;d=X.Clamp(w/C,0,1),f=1-d}else f=X.Clamp(-h/l,0,1),d=0}else if(f<0)if(a+c>o+h){const u=l+h-o-c,v=a-2*o+l;d=X.Clamp(u/v,0,1),f=1-d}else d=X.Clamp(-h/l,0,1),f=0;else{const u=l+h-o-c,v=a-2*o+l;d=X.Clamp(u/v,0,1),f=1-d}return t[0].add(e.scale(d)).add(i.scale(f))}class hr{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","Structure","Transparentable"));s(this,"initTransparentable",t=>{t.Structure.meshes.forEach(e=>{e.material&&e.material instanceof ue&&(e.material.transparencyMode=2)})});s(this,"afterRenderExecute",t=>{const e=t.activeCamera;if(e===null||!(e instanceof Ae))return;const i=e.beta,n=.55,a=fi(20),o=a+fi(60);let l=(i-a)/(o-a);l>1&&(l=1),l<0&&(l=0);const c=1-l*(1-n);if(!Number.isNaN(c))for(const h of this.targetArchetype.entities)h.Structure.meshes.forEach(d=>{d.material&&d.material instanceof ue&&(d.material.alpha=c)})});this.targetArchetype.onEntityAdded.add(t=>this.initTransparentable(t))}dispose(){y(this.targetArchetype)}}const dt=class{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","VideoPlayer"));s(this,"initVideoPlayer",t=>{t.VideoPlayer.mesh.isPickable=!0});dt.instance=this,this.targetArchetype.onEntityAdded.add(t=>this.initVideoPlayer(t))}static getVideoPlayers(){var t;return((t=this.instance)==null?void 0:t.getVideoPlayers())??[]}dispose(){dt.instance=void 0;for(const t of this.targetArchetype.entities){const e=t.VideoPlayer;if(e.videoTexture){const i=e.videoTexture.video;for(e.videoTexture.dispose();i.firstChild;)i.lastChild&&i.removeChild(i.lastChild);i.src="",i.removeAttribute("src"),i.remove()}}y(this.targetArchetype)}onPointerUp(t){const e=t.pickInfo;if(e)for(const i of this.targetArchetype.entities){const n=i.VideoPlayer;e.pickedMesh===n.mesh&&(n.videoTexture?n.videoTexture.video.paused?St(n):Ai(n):St(n))}}getVideoPlayers(){return this.targetArchetype.entities.map(t=>{const e=t.VideoPlayer;return{play:()=>St(e),pause:()=>Ai(e),setVolume:i=>Cr(e,i)}})??[]}};let He=dt;s(He,"instance");class dr{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","Structure","Ceiling"));s(this,"hideHeights",new Map);s(this,"initCeiling",t=>{let e=this.hideHeights.get(t.entityId);e||(e=t.Structure.meshes.flatMap(i=>i.getBoundingInfo().boundingBox).flatMap(i=>i.centerWorld.y-i.extendSizeWorld.y),this.hideHeights.set(t.entityId,e))});s(this,"afterRenderExecute",t=>{if(t._activeCamera)for(const e of this.targetArchetype.entities){const i=e.Structure;let n=this.hideHeights.get(e.entityId);if(!n)return;for(let a=0;a<i.meshes.length;a++){const o=t._activeCamera.position.y<=n[a];i.meshes[a].visibility=o?1:0}}});this.targetArchetype.onEntityAdded.add(t=>this.initCeiling(t))}dispose(){y(this.targetArchetype),this.hideHeights.clear()}}const mt=class{constructor(){s(this,"transforms",p.with("TransformNode"));s(this,"transformsDirty",this.transforms.with("TransformDirty"));s(this,"dynamicTransforms",this.transforms.with("TransformMovable"));s(this,"staticTransforms",this.transforms.without("TransformMovable"));s(this,"staticTransformsDirty",this.transformsDirty.without("TransformMovable"));s(this,"activeDynamicTransforms",this.dynamicTransforms.with("ActiveHome","Identifier"));s(this,"lastTransforms",new Map);s(this,"whenDynamicTransform",t=>{var a;const{TransformNode:e,TransformMovable:i}=t;e.unfreezeWorldMatrix(),e.getChildMeshes().forEach(o=>{o.unfreezeWorldMatrix(),o.doNotSyncBoundingInfo=!1}),this.lastTransforms.set(t,e.getWorldMatrix().clone()),e instanceof ei&&((a=e.getScene().selectionOctree)==null||a.dynamicContent.push(e));const n=i.magnetismFixtureFace;if(n){const{min:o,max:l}=e.getHierarchyBoundingVectors(!0),c=e.getWorldMatrix().clone().invert(),h=g.TransformCoordinates(o,c),m=g.TransformCoordinates(l,c),d=new qi(g.Minimize(h,m),g.Maximize(h,m)),f=d.boundingBox.minimum,u=d.boundingBox.maximum;let v=[];const w=n.bottom?f.y:n.top?u.y:0;n.front&&v.push({position:new g(0,w,u.z),normal:g.Forward(),constraints:[{type:"padding",value:new g(Number.MAX_VALUE,0,Number.MAX_VALUE)}]}),n.back&&v.push({position:new g(0,w,f.z),normal:g.Backward(),constraints:[{type:"padding",value:new g(Number.MAX_VALUE,0,Number.MAX_VALUE)}]}),n.left&&v.push({position:new g(f.x,w,0),normal:g.Left(),constraints:[{type:"padding",value:new g(Number.MAX_VALUE,0,Number.MAX_VALUE)}]}),n.right&&v.push({position:new g(u.x,w,0),normal:g.Right(),constraints:[{type:"padding",value:new g(Number.MAX_VALUE,0,Number.MAX_VALUE)}]}),n.top&&v.push({position:new g(0,w,0),normal:g.Up(),constraints:[{type:"normal",value:g.Down()}]}),n.bottom&&v.push({position:new g(0,w,0),normal:g.Down(),constraints:[{type:"normal",value:g.Up()}]}),v.length>0&&p.addComponent(t,"MagnetismFixtures",{fixtures:v})}});s(this,"whenStaticTransform",t=>{var i,n;const{TransformNode:e}=t;if(e.freezeWorldMatrix(),this.lastTransforms.delete(t),e instanceof ei){const a=e.getScene(),o=(i=a.selectionOctree)==null?void 0:i.dynamicContent.indexOf(e);o>=0&&((n=a.selectionOctree)==null||n.dynamicContent.splice(o,1))}});s(this,"beforeRenderExecute",t=>{this.staticTransformsDirty.size>0&&t.selectionOctree&&t.createOrUpdateSelectionOctree();for(const e of this.dynamicTransforms){const i=this.lastTransforms.get(e);if(!i)continue;const{TransformNode:n}=e;n.getWorldMatrix().equals(i)||p.addComponent(e,"TransformDirty",!0)}});s(this,"afterRenderExecute",t=>{for(const e of this.transformsDirty){p.removeComponent(e,"TransformDirty");const i=this.lastTransforms.get(e);if(!i)continue;const{TransformNode:n}=e;i.copyFrom(n.getWorldMatrix())}});s(this,"updatePosition",(t,e,i)=>{const n=t.TransformNode;if(e!==void 0&&n.setAbsolutePosition(e),i!==void 0){const a=$.FromDegrees(i%360).radians();n.rotation=new g(0,a,0)}});mt.instance=this,this.dynamicTransforms.onEntityAdded.add(t=>this.whenDynamicTransform(t)),this.staticTransforms.onEntityAdded.add(t=>this.whenStaticTransform(t))}static updateTransform(t,e,i){var n;(n=this.instance)==null||n.updateTransform(t,e,i)}static getMovableTransformEntities(){var t;return((t=this.instance)==null?void 0:t.getMovableTransformEntities())??[]}static getMovableTransformEntitiesInFloorplan(t){var e;return((e=this.instance)==null?void 0:e.getMovableTransformEntitiesInFloorplan(t))??[]}dispose(){mt.instance=void 0,y(this.transforms),y(this.transformsDirty),y(this.dynamicTransforms),y(this.staticTransforms),y(this.staticTransformsDirty),y(this.activeDynamicTransforms),this.lastTransforms.clear()}updateTransform(t,e,i){if(e!==void 0||i!==void 0){const a=this.activeDynamicTransforms.entities.find(o=>o.entityId==t);a&&(this.updatePosition(a,e,i),b.RenderUpdate())}}getMovableTransformEntities(){return this.activeDynamicTransforms.entities??[]}getMovableTransformEntitiesInFloorplan(t){return this.activeDynamicTransforms.entities.filter(e=>e.Identifier.floorplanId===t)??[]}};let pe=mt;s(pe,"instance");const mr={lerpTime:0},Zt=class{constructor(t){s(this,"toAddGhost",p.with("ActiveHome","TransformNode","MagnetismValid").without("MagnetismGhost"));s(this,"toRemoveGhost",p.with("ActiveHome","TransformNode","MagnetismGhost").without("MagnetismValid"));s(this,"activeGhost",p.with("ActiveHome","TransformNode","MagnetismValid","MagnetismGhost"));s(this,"options");s(this,"beforeRenderExecute",t=>{this.toAddGhost.entities.forEach(this.addGhost),this.toRemoveGhost.entities.forEach(this.removeGhost),this.activeGhost.entities.forEach(this.moveGhost)});s(this,"addGhost",t=>{const{TransformNode:e}=t,i=e.clone(`${Zt.prefix}${e.name}`,e.parent);i&&(i.freezeWorldMatrix(e.getWorldMatrix()),e.getChildMeshes().forEach(n=>{n.visibility=0}),p.addComponent(t,"MagnetismGhost",{rootNode:i}),b.instance.playingVideoCount++)});s(this,"removeGhost",t=>{const{TransformNode:e,MagnetismGhost:i}=t;i.rootNode.dispose(),e.getChildMeshes().forEach(a=>{a.visibility=1}),p.removeComponent(t,"MagnetismGhost"),b.instance.playingVideoCount--});s(this,"moveGhost",t=>{const{MagnetismValid:e,MagnetismGhost:i}=t,n=i.rootNode,a=this.options.lerpTime==0?e.matrix:xe.DecomposeLerp(n.getWorldMatrix(),e.matrix,this.options.lerpTime);n.freezeWorldMatrix(a)});this.options={...mr,...t}}dispose(){y(this.toAddGhost),y(this.toRemoveGhost),y(this.activeGhost)}};let it=Zt;s(it,"prefix","MagnetismGhost_");const ur={defaultMaxDistance:.01,isDebug:!1};class fr{constructor(t){s(this,"withMagnetism",p.with("ActiveHome","TransformNode","MagnetismFixtures"));s(this,"magnetismEnabled",this.withMagnetism.with("TransformDirty"));s(this,"magnetismDone",this.withMagnetism.with("MagnetismValid").without("PointerDragging"));s(this,"magnetismTarget",p.with("ActiveHome","Structure","MagnetismTarget"));s(this,"options");s(this,"beforeRenderExecute",t=>{this.calculateMagnetism(),this.finishMagnetism()});s(this,"calculateMagnetism",()=>{if(this.magnetismEnabled.size<1)return;$e.LastCreatedScene.createOrUpdateSelectionOctree();for(const e of this.magnetismEnabled){const{MagnetismFixtures:i,TransformNode:n}=e,a=n,o=a.getWorldMatrix(),l=a.getWorldMatrix().clone(),c=[...i.fixtures],h=[];for(;c.length>0;){const m=this.findClosestFixture(l,c);if(!m)break;c.splice(m.index,1),h.push(m.fixture);const{fixture:d,facePosition:f,faceNormal:u}=m,v=G.Vector3[0],w=G.Quaternion[0],C=G.Vector3[1];o.decompose(v,w,C);const x=w.toEulerAngles();xe.ComposeToRef(v,W.RotationYawPitchRoll(d.normal.y!=0?Math.PI+x.y:-Math.atan2(u.x,-u.z)-Math.atan2(d.normal.x,-d.normal.z),Math.PI+Math.atan2(u.y,Math.sqrt(u.z*u.z+u.x*u.x))+Math.atan2(d.normal.y,Math.sqrt(d.normal.z*d.normal.z+d.normal.x*d.normal.x)),0),g.ZeroReadOnly,l),l.setTranslation(f.subtract(g.TransformCoordinates(d.position,l))),this.options.isDebug&&this.drawDebug(d,o,a,f,u)}i.fixtures.length===c.length?p.removeComponent(e,"MagnetismValid"):p.update(e,"MagnetismValid",{fixtures:h,matrix:l})}});s(this,"findClosestFixture",(t,e)=>e.flatMap((n,a)=>this.magnetismTarget.entities.flatMap(o=>o.Structure.meshes.flatMap(c=>{if(!(c instanceof Ji))return[];const h=c.getWorldMatrix(),m=xe.Invert(h),d=t.multiply(m),f=g.TransformCoordinates(n.position,d),u=c.getVerticesData(ti.NormalKind),v=c.getVerticesData(ti.PositionKind),w=c.getIndices(),x=[...Array(w.length/3|0)].flatMap((Ye,ie)=>{var Jt;var Te=w[3*ie]*3,Ke=w[3*ie+1]*3,Xt=w[3*ie+2]*3;const Yt=[G.Vector3[0].fromArray(u,Te),G.Vector3[1].fromArray(u,Ke),G.Vector3[2].fromArray(u,Xt)],ji=Yt.reduce((ce,Zi)=>ce.addInPlace(Zi),G.Vector3[3].setAll(0)).scaleInPlace(1/Yt.length).normalize(),De=g.TransformNormal(ji,h);if(!(((Jt=n.constraints)==null?void 0:Jt.some(ce=>{switch(ce.type){case"padding":return ce.value.x+Et>=Math.abs(De.x)&&ce.value.y+Et>=Math.abs(De.y)&&ce.value.z+Et>=Math.abs(De.z);case"normal":return De.equalsWithEpsilon(ce.value)}}))??!0))return[];const Gi=[G.Vector3[0].fromArray(v,Te),G.Vector3[1].fromArray(v,Ke),G.Vector3[2].fromArray(v,Xt)],Kt=cr(f,Gi),qt=g.DistanceSquared(f,Kt);return qt>(n.maxDistance??this.options.defaultMaxDistance)?[]:[{candidate:c,faceIndex:ie,facePosition:g.TransformCoordinates(Kt,h),distance:qt,faceNormal:De}]}).sort(({distance:Ye},{distance:ie})=>Ye-ie)[0];return x?[{index:a,fixture:n,...x}]:[]}))).sort(({distance:n},{distance:a})=>n-a)[0]);s(this,"drawDebug",(t,e,i,n,a)=>{he.Color4[0].set(0,1,1,1),he.Color4[1].set(0,1,0,1),he.Color4[2].set(1,1,0,1);const o=new Be(1,0,1,1),l=g.TransformCoordinates(t.position,e),c=g.TransformNormal(t.normal,e),h=en.CreateLineSystem(`${i.name}_debugLine`,{lines:[[l,n],[n,n.add(a.scale(.1))],[l,l.add(c.scale(.1))]],colors:[[he.Color4[0],he.Color4[1]],[he.Color4[2],he.Color4[2]],[o,o]]},ii.DefaultKeepDepthUtilityLayer.utilityLayerScene);ii.DefaultKeepDepthUtilityLayer.utilityLayerScene.onAfterRenderObservable.addOnce(()=>{h.dispose()})});s(this,"finishMagnetism",()=>{for(const t of this.magnetismDone){const{TransformNode:e,MagnetismValid:i}=t;(e.parent?i.matrix.multiply(xe.Invert(e.parent.getWorldMatrix())):i.matrix).decomposeToTransformNode(e),p.removeComponent(t,"MagnetismValid")}});this.options={...ur,...t}}dispose(){y(this.withMagnetism),y(this.magnetismEnabled),y(this.magnetismDone),y(this.magnetismTarget)}}const ut=class{constructor(){s(this,"draggingable",!1);s(this,"targetArchetype",p.with("PointerDraggable","TransformNode","TransformMovable"));s(this,"targetMovableArchetype",p.with("ActiveHome","TransformNode","TransformMovable"));s(this,"behaviorMap",new Map);s(this,"attachBehavior",t=>{const{TransformNode:e}=t,i=new tn({dragPlaneNormal:g.UpReadOnly});i.dragDeltaRatio=1,i.onDragStartObservable.add(()=>{p.addComponent(t,"PointerDragging",!0),b.RenderUpdate()}),i.onDragObservable.add(()=>{b.RenderUpdate()}),i.onDragEndObservable.add(()=>{p.removeComponent(t,"PointerDragging"),b.RenderUpdate()}),e.addBehavior(i),this.behaviorMap.set(t,i)});s(this,"detachBehavior",t=>{const{TransformNode:e}=t,i=this.behaviorMap.get(t);i&&(e.removeBehavior(i),this.behaviorMap.delete(t))});s(this,"allUpdatePointerDraggable",()=>{this.targetMovableArchetype.entities.forEach(t=>this.updatePointerDraggable(t))});s(this,"updatePointerDraggable",t=>{this.draggingable?t.PointerDraggable||p.addComponent(t,"PointerDraggable",!0):t.PointerDraggable&&p.removeComponent(t,"PointerDraggable"),t.TransformNode.getChildMeshes().forEach(e=>e.isPickable=this.draggingable)});ut.instance=this,this.targetArchetype.onEntityAdded.add(t=>this.attachBehavior(t)),this.targetArchetype.onEntityRemoved.add(t=>this.detachBehavior(t)),this.targetMovableArchetype.onEntityAdded.add(t=>this.updatePointerDraggable(t))}static setEnableDraggingMovable(t){var e;(e=this.instance)==null||e.setEnableDraggingMovable(t)}dispose(){ut.instance=void 0,this.behaviorMap.clear(),y(this.targetArchetype),y(this.targetMovableArchetype)}setEnableDraggingMovable(t){this.draggingable=t,this.allUpdatePointerDraggable()}};let Ue=ut;s(Ue,"instance");const je=class{constructor(){s(this,"targetArchetype",p.with("Identifier"));s(this,"updateActiveHome",t=>{t.Identifier.homeId===je.activeHomeId?t.ActiveHome||p.addComponent(t,"ActiveHome",!0):t.ActiveHome&&p.removeComponent(t,"ActiveHome")});s(this,"allUpdateActiveHome",()=>{this.targetArchetype.entities.forEach(this.updateActiveHome)});je.instance=this,this.targetArchetype.onEntityAdded.add(t=>this.updateActiveHome(t))}static setActiveHome(t){var e;this.activeHomeId=t,(e=this.instance)==null||e.allUpdateActiveHome()}dispose(){je.instance=void 0,y(this.targetArchetype)}};let Ce=je;s(Ce,"activeHomeId",""),s(Ce,"instance");const Di=30,D=async(r,t,e=!1)=>{let i=t||$e.LastCreatedScene;if(!i)return;let n=[];Array.isArray(r.property)?n.push(...r.property.map(o=>gi(o,r.easingFunction))):n.push(gi(r.property,r.easingFunction));let a=0;for(let o=0;o<n.length;o++)n[o].getKeys().forEach(l=>{a=Math.max(l.frame,a)});if(Array.isArray(r.target)){const o=r.target.flatMap(l=>i?vi(i,l,n,a,e):[]);r.onAnimationEnd&&(await Promise.all(o.map(l=>l.waitAsync())),r.onAnimationEnd())}else{const o=vi(i,r.target,n,a,e);r.onAnimationEnd&&(await o.waitAsync(),r.onAnimationEnd())}},nt=(r,t)=>new q(r,r,Di,t,q.ANIMATIONLOOPMODE_CONSTANT),gi=(r,t)=>{let e=0;Array.isArray(r.keyFrame)?e=bi(r.keyFrame[0].from):e=bi(r.keyFrame.from);const i=nt(r.targetProperty,e);if(t&&i.setEasingFunction(t),Array.isArray(r.keyFrame)){let n=0;r.keyFrame.forEach(a=>{let o=0;a.duration!==void 0?o=ot(a.duration):a.frame!==void 0&&(o=a.frame),pi(i,a,n,n+o),n+=o})}else{let n=0;r.keyFrame.duration!==void 0?n=ot(r.keyFrame.duration):r.keyFrame.frame!==void 0&&(n=r.keyFrame.frame),pi(i,r.keyFrame,0,n)}return i},pi=(r,t,e,i)=>{r.setKeys([{frame:e,value:t.from},{frame:i,value:t.to}])},vi=(r,t,e,i,n)=>{t.animations=e;const a=r.beginAnimation(t,0,i,!1,1,void 0,void 0,n);return a.disposeOnEnd=!0,a},gr="number",bi=r=>typeof r===gr?q.ANIMATIONTYPE_FLOAT:r instanceof g?q.ANIMATIONTYPE_VECTOR3:r instanceof J?q.ANIMATIONTYPE_COLOR3:q.ANIMATIONTYPE_FLOAT,ot=r=>Math.round(r*Di);var ee=(r=>(r[r.CircleEase=0]="CircleEase",r[r.BackEase=1]="BackEase",r[r.BounceEase=2]="BounceEase",r[r.CubicEase=3]="CubicEase",r[r.ElasticEase=4]="ElasticEase",r[r.ExponentialEase=5]="ExponentialEase",r[r.PowerEase=6]="PowerEase",r[r.QuadraticEase=7]="QuadraticEase",r[r.QuarticEase=8]="QuarticEase",r[r.QuinticEase=9]="QuinticEase",r[r.SineEase=10]="SineEase",r[r.BezierCurveEase=11]="BezierCurveEase",r))(ee||{}),te=(r=>(r[r.Out=0]="Out",r[r.In=1]="In",r[r.InOut=2]="InOut",r))(te||{});const Kr=()=>{let r={},t=Object.keys(ee).map(e=>ee[e]).filter(e=>typeof e=="string");for(let e of t)r[e]=ee[e];return r},qr=()=>{let r={},t=Object.keys(te).map(e=>te[e]).filter(e=>typeof e=="string");for(let e of t)r[e]=te[e];return r},Ze=(r,t)=>{let e=new zt;switch(e.setEasingMode(ze.EASINGMODE_EASEOUT),r){case 0:e=new zt;break;case 1:e=new un;break;case 2:e=new mn;break;case 3:e=new dn;break;case 4:e=new hn;break;case 5:e=new cn;break;case 6:e=new ln;break;case 7:e=new on;break;case 8:e=new sn;break;case 9:e=new an;break;case 10:e=new rn;break;case 11:e=new nn;break}switch(t){case 0:e.setEasingMode(ze.EASINGMODE_EASEOUT);break;case 1:e.setEasingMode(ze.EASINGMODE_EASEIN);break;case 2:e.setEasingMode(ze.EASINGMODE_EASEINOUT);break}return e};class pr{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","ThingState","Openable"));s(this,"targetArchetypeDirty",this.targetArchetype.with("ThingStateDirty"));s(this,"openEasingFunction",Ze(ee.QuadraticEase,te.Out));s(this,"closeEasingFunction",Ze(ee.QuarticEase,te.Out));s(this,"initEntity",t=>{const e=t.Openable;e.target.unfreezeWorldMatrix(),e.target.getChildMeshes().forEach(i=>i.unfreezeWorldMatrix())});s(this,"updateState",t=>{const e=t.Openable,i=t.ThingState,n=i.state;if(!n)return;const a=.8;if(i.type===Oe.Door){const o=n.isOpen;D(o?{target:e.target,property:{targetProperty:"rotation",keyFrame:{duration:a,from:e.closeRotation,to:e.openRotation}},easingFunction:this.openEasingFunction}:{target:e.target,property:{targetProperty:"rotation",keyFrame:{duration:a,from:e.openRotation,to:e.closeRotation}},easingFunction:this.closeEasingFunction})}else{const o=n.isOpen;D(o?{target:e.target,property:{targetProperty:"position",keyFrame:{duration:a,from:e.closePosition,to:e.openPosition}},easingFunction:this.openEasingFunction}:{target:e.target,property:{targetProperty:"position",keyFrame:{duration:a,from:e.openPosition,to:e.closePosition}},easingFunction:this.closeEasingFunction})}});this.targetArchetype.onEntityAdded.add(t=>this.initEntity(t)),this.targetArchetypeDirty.onEntityAdded.add(t=>this.updateState(t))}dispose(){y(this.targetArchetype),y(this.targetArchetypeDirty)}}const ft=class{constructor(){s(this,"targetArchetype",p.with("Identifier","TransformNode","Structure","ThingState","LightController"));s(this,"targetArchetypeInActiveHome",this.targetArchetype.with("ActiveHome"));s(this,"targetArchetypeDirty",this.targetArchetypeInActiveHome.with("ThingStateDirty"));s(this,"updateState",t=>{const e=t.ThingState.state;ye.instance.setRoomLightColor(t.entityId,e.isOn,e.intensity)});ft.instance=this,this.targetArchetypeDirty.onEntityAdded.add(t=>this.updateState(t))}dispose(){ft.instance=void 0,y(this.targetArchetype),y(this.targetArchetypeInActiveHome),y(this.targetArchetypeDirty)}};let rt=ft;s(rt,"instance");const gt=class{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","ThingState"));s(this,"thingStateDirtyArchetype",this.targetArchetype.with("ThingStateDirty"));s(this,"lastState",new Map);s(this,"initEntity",t=>{this.lastState.set(t,t.ThingState.state)});s(this,"beforeRenderExecute",t=>{for(const e of this.targetArchetype){const i=this.lastState.get(e);if(!i)continue;e.ThingState.state!==i&&p.addComponent(e,"ThingStateDirty",!0)}});s(this,"afterRenderExecute",t=>{for(const e of this.thingStateDirtyArchetype)p.removeComponent(e,"ThingStateDirty"),this.lastState.get(e)&&this.lastState.set(e,e.ThingState.state)});gt.instance=this,this.targetArchetype.onEntityAdded.add(t=>this.initEntity(t))}static getThingStateEntities(){var t;return((t=this.instance)==null?void 0:t.getThingStateEntities())??[]}static getThingStateEntitiesInFloorplan(t){var e;return((e=this.instance)==null?void 0:e.getThingStateEntitiesInFloorplan(t))??[]}static updateThingState(t,e){var i;(i=this.instance)==null||i.updateThingState(t,e)}dispose(){gt.instance=void 0,y(this.targetArchetype),y(this.thingStateDirtyArchetype),this.lastState.clear()}getThingStateEntities(){return this.targetArchetype.entities??[]}getThingStateEntitiesInFloorplan(t){return this.targetArchetype.entities.filter(e=>e.Identifier.floorplanId==t)}updateThingState(t,e){const i=this.targetArchetype.entities.find(n=>n.entityId===t);if(i){const n=i.ThingState;n&&(n.state=e,z.instance.onEntityStateChanged.notifyObservers(t),b.RenderUpdate())}}};let ve=gt;s(ve,"instance");const pt=class{constructor(){s(this,"targetArchetype",p.with("Identifier","Floorplan"));s(this,"targetArchetypeInActiveHome",this.targetArchetype.with("ActiveHome"));pt.instance=this}static getFloorplanEntities(){var t;return((t=this.instance)==null?void 0:t.getFloorplanEntities())??[]}static getFloorplanEntitiesInActiveHome(){var t;return((t=this.instance)==null?void 0:t.getFloorplanEntitiesInActiveHome())??[]}static getFloorplanEntity(t){var e;return(e=this.instance)==null?void 0:e.getFloorplanEntity(t)}dispose(){pt.instance=void 0,y(this.targetArchetype),y(this.targetArchetypeInActiveHome)}getFloorplanEntities(){return this.targetArchetype.entities??[]}getFloorplanEntitiesInActiveHome(){return this.targetArchetypeInActiveHome.entities??[]}getFloorplanEntity(t){return this.targetArchetype.entities.find(e=>e.Identifier.floorplanId==t)}};let se=pt;s(se,"instance");const vt=class{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","TransformNode","CameraTarget"));vt.instance=this}static getCameraTargetEntities(){var t;return((t=this.instance)==null?void 0:t.getCameraTargetEntities())??[]}static getCameraTargetEntitiesInFloorplan(t){var e;return((e=this.instance)==null?void 0:e.getCameraTargetEntitiesInFloorplan(t))??[]}static getCameraTargetEntityWithSameName(t){var i;return(i=this.instance)==null?void 0:i.targetArchetype.entities.find(n=>n.TransformNode.name==t)}dispose(){vt.instance=void 0,y(this.targetArchetype)}getCameraTargetEntities(){return this.targetArchetype.entities??[]}getCameraTargetEntitiesInFloorplan(t){return this.targetArchetype.entities.filter(e=>e.Identifier.floorplanId==t)??[]}};let Pe=vt;s(Pe,"instance");const bt=class{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","Structure","Hallway"));s(this,"initTransparentable",t=>{t.Structure.meshes.forEach(e=>{e.material&&e.material instanceof ue&&(e.visibility=0,e.material.environmentIntensity=1)})});bt.instance=this,this.targetArchetype.onEntityAdded.add(t=>this.initTransparentable(t))}static setHallwayVisibility(t){var e;(e=this.instance)==null||e.setHallwayVisibility(t)}dispose(){bt.instance=void 0,y(this.targetArchetype)}setHallwayVisibility(t){for(const e of this.targetArchetype.entities)for(const i of e.Structure.meshes)i.visibility=t;b.RenderUpdate()}};let Ve=bt;s(Ve,"instance");const yt=class{constructor(){s(this,"targetArchetype",p.with("Identifier","TransformNode","Structure","MaterialChangeable"));yt.instance=this}static getMaterialChangeableEntities(){var t;return((t=this.instance)==null?void 0:t.getMaterialChangeable())??[]}static getMaterialChangeableEntitiesInFloorplan(t){var e;return((e=this.instance)==null?void 0:e.getMaterialChangeableInFloorplan(t))??[]}dispose(){yt.instance=void 0,y(this.targetArchetype)}getMaterialChangeable(){return this.targetArchetype.entities}getMaterialChangeableInFloorplan(t){return this.targetArchetype.entities.filter(e=>e.Identifier.floorplanId==t)}};let be=yt;s(be,"instance");const At=class{constructor(){s(this,"targetArchetype",p.with("ActiveHome","Identifier","Structure"));At.instance=this}static getStructureMeshesByType(t){var e;return((e=this.instance)==null?void 0:e.getStructureMeshesByType(t))??[]}dispose(){At.instance=void 0,y(this.targetArchetype)}getStructureEntities(){return this.targetArchetype.entities??[]}getStructureEntitiesByType(t){return this.getStructureEntities().filter(e=>e.Structure.structureType==t)??[]}getStructureMeshesByType(t){return this.getStructureEntitiesByType(t).flatMap(e=>e.Structure.meshes)??[]}};let ke=At;s(ke,"instance");const Tt=class{constructor(){s(this,"roomArchetype",p.with("Identifier","TransformNode","Room","Structure"));s(this,"roomObjectArchetype",p.with("Identifier","TransformNode","RoomObject"));s(this,"roomObjectDirtyArchetype",this.roomObjectArchetype.with("TransformDirty"));s(this,"initRoom",t=>{for(let e=0;t.Room.viewDataList&&e<t.Room.viewDataList.length;e++){const i=t.Room.viewDataList[e].position;t.Room.viewDataList[e].position=new g(i.x,i.y,i.z);const n=t.Room.viewDataList[e].rotation;t.Room.viewDataList[e].rotation=new g(n.x*R,n.y*R,n.z*R)}t.Structure.meshes.forEach(e=>{e.isPickable=!0,ye.instance.registRoomLightMaterial(t.entityId,e.material)})});s(this,"rayDirection",g.Up().scale(-1));s(this,"rayDistance",1e3);s(this,"updateRoom",t=>{if(t.Room)return;const e=t.TransformNode,i=t.Structure,n=e.getHierarchyBoundingVectors();let a=n.max.add(n.min).scale(.5);a.y=2;let o,l;if(i)o=this.pickWithRay([a]),l=i.meshes;else{const c=e.forward,h=a.add(c.scale(.5)),m=a.add(c.scale(-.5));o=this.pickWithRay([a,h,m]),l=e.getChildMeshes()}if(o&&l&&t.RoomObject.roomEntityId!==o.entityId){const c=o.entityId;t.RoomObject.roomEntityId=c,l.forEach(h=>ye.instance.registRoomLightMaterial(c,h.material))}});s(this,"pickWithRay",t=>{const e=$e.LastCreatedScene;if(!e)return;let i;for(let n=0;n<t.length;n++){const a=t[n];i?i.origin=a:i=new fn(a,this.rayDirection,this.rayDistance);let o;if(e.pickWithRay(i,l=>(o=this.checkPickedMeshIsRoomMesh(l),!!o),!0),o)return o}});Tt.instance=this,this.roomArchetype.onEntityAdded.add(t=>this.initRoom(t)),this.roomObjectDirtyArchetype.onEntityAdded.add(t=>this.updateRoom(t))}static updateRoomInFloorplan(t){var e;(e=this.instance)==null||e.updateRoomInFloorplan(t)}static getRooms(t){var e,i;return((i=this.instance)==null?void 0:i.RoomInfoByEntities((e=this.instance)==null?void 0:e.getRooms(t)))??[]}static getRoomObjects(t){var e,i;return((i=this.instance)==null?void 0:i.RoomObjectInfoByEntities((e=this.instance)==null?void 0:e.getRoomObjects(t)))??[]}static getRoomObjectsOnlyThing(t){var e,i;return((i=this.instance)==null?void 0:i.RoomObjectInfoByEntities((e=this.instance)==null?void 0:e.getRoomObjectsOnlyThing(t)))??[]}dispose(){Tt.instance=void 0,y(this.roomArchetype),y(this.roomObjectArchetype),y(this.roomObjectDirtyArchetype)}updateRoomInFloorplan(t){this.roomObjectArchetype.entities.filter(e=>e.Identifier.floorplanId===t&&!e.Room).forEach(e=>this.updateRoom(e))}checkPickedMeshIsRoomMesh(t){for(const e of this.roomArchetype.entities)for(const i of e.Structure.meshes)if(i===t)return e}getRooms(t){return this.roomArchetype.entities.flatMap(e=>!t||e.Identifier.floorplanId===t?e:[])??[]}getRoomObjects(t){return this.roomObjectArchetype.entities.flatMap(e=>{let i=e.RoomObject.roomEntityId??(e.Room?e.entityId:void 0);return i?t?i===t?e:[]:e:[]})??[]}getRoomObjectsOnlyThing(t){return this.getRoomObjects(t).flatMap(e=>e.ThingState?e:[])??[]}RoomInfoByEntities(t){return t.flatMap(e=>({floorplanId:e.Identifier.floorplanId,roomEntityId:e.entityId,name:e.TransformNode.name,center:e.TransformNode.position,extends:e.Room.extends,viewDataList:e.Room.viewDataList}))??[]}RoomObjectInfoByEntities(t){return t.flatMap(e=>({roomEntityID:e.RoomObject.roomEntityId??e.entityId,objectEntityId:e.entityId,name:e.TransformNode.name,position:e.TransformNode.position,forward:e.TransformNode.forward,ThingState:e.ThingState}))??[]}};let oe=Tt;s(oe,"instance");class yi{constructor(t,e,i){s(this,"DEFAULT_ANIMATION_OPTION",new Pr);s(this,"DEFAULT_CAMERA_ANGLE",new V);this.engine=t,this.scene=e,this.zedCamera=i,this.engine=t,this.scene=e,this.zedCamera=i}async moveTo(t){t.cameraAngle===void 0&&(t.cameraAngle=this.DEFAULT_CAMERA_ANGLE),t.isRelativeAngle===void 0&&(t.isRelativeAngle=!1),t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION);const e=t.animationOption;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode),await this.zedCamera.moveTo(t.position,t.cameraAngle,t.isRelativeAngle,e.seconds)}getCameraTargetEntities(){return Pe.getCameraTargetEntities()}getCameraTargetEntityWithSameName(t){return Pe.getCameraTargetEntityWithSameName(t)}async moveToCameraTarget(t){const e=this.getCameraTargetEntityWithSameName(t.targetName);if(!e)return;t.cameraAngle===void 0&&(t.cameraAngle=this.DEFAULT_CAMERA_ANGLE),t.dist===void 0&&(t.dist=2),t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION),t.fromForward===void 0&&(t.fromForward=!0);const i=e.TransformNode,n=t.animationOption;this.zedCamera.setEasingFunction(n.easingFunction,n.easingMode),await this.zedCamera.moveToCameraTarget(i.absolutePosition,i.forward,t.cameraAngle,t.dist,n.seconds,t.fromForward)}async moveToCoordinate(t){t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION);const e=t.animationOption;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode),await this.zedCamera.moveToCoordinate(t.position,t.rotation,e.seconds)}quaterView(t=45,e=45,i){const n=i||this.DEFAULT_ANIMATION_OPTION;this.zedCamera.setEasingFunction(n.easingFunction,n.easingMode),this.zedCamera.quaterView(t,e,n.seconds)}quaterViewFit(t=45,e=45,i){const n=i||this.DEFAULT_ANIMATION_OPTION;this.zedCamera.setEasingFunction(n.easingFunction,n.easingMode);const a=this.getExtendsOrSceneExtends(),o=this.engine.getRenderWidth(),l=this.engine.getRenderHeight(),c=o/l,h=c*100>100?100:c*100;this.zedCamera.quaterViewFit(t,e,n.seconds,h,a)}topViewFit(t){const e=t||this.DEFAULT_ANIMATION_OPTION;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode);const i=this.getExtendsOrSceneExtends();this.zedCamera.topViewFit(e.seconds,i)}topViewCustom(t){t.x===void 0&&(t.x=0),t.y===void 0&&(t.y=0),t.zoomPercent===void 0&&(t.zoomPercent=100),t.rotation===void 0&&(t.rotation=0),t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION);const e=t.animationOption;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode),this.zedCamera.topViewCustom(t.x,t.y,t.zoomPercent,t.rotation,e.seconds,this.getExtendsOrSceneExtends())}zoomIn(t){t===void 0&&(t={}),t.percent===void 0&&(t.percent=30),t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION);const e=t.animationOption;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode),this.zedCamera.zoomIn(t.percent,e.seconds)}zoomOut(t){t===void 0&&(t={}),t.percent===void 0&&(t.percent=30),t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION);const e=t.animationOption;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode),this.zedCamera.zoomOut(t.percent,e.seconds)}setDistance(t){t.distance===void 0&&(t.distance=5),t.animationOption===void 0&&(t.animationOption=this.DEFAULT_ANIMATION_OPTION);const e=t.animationOption;this.zedCamera.setEasingFunction(e.easingFunction,e.easingMode),this.zedCamera.setDistance(t.distance,e.seconds)}zoomFitOnInit(){const t=this.getExtendsOrSceneExtends();this.zedCamera.zoomFitOnInit(t)}getExtendsOrSceneExtends(){let t;const e=se.getFloorplanEntities();return e.length>0&&(t=e[0].Floorplan.extends),t||this.scene.getWorldExtends()}setTargetFloor(t,e=!1,i){i===void 0&&(i=this.DEFAULT_ANIMATION_OPTION),this.zedCamera.setEasingFunction(i.easingFunction,i.easingMode);const n=se.getFloorplanEntity(t);if(n){const a=e;this.zedCamera.initWithExtends(n.Floorplan.extends,a,i.seconds)}}setViewport(t){this.zedCamera.setViewport(t),this.scene.render()}transformViewport(t,e,i){this.zedCamera.transformViewport(t,e,i)}transformFromCurrentViewport(t,e){const i=this.zedCamera.getViewport();this.zedCamera.transformViewport(i,t,e)}alignViewport(t,e,i,n){const a=this.engine.getRenderWidth(),o=this.engine.getRenderHeight(),l=a/o,c=this.zedCamera.getViewport();let h=new Sr(0,0,e?.7:1,1);l>1&&(i.column==="left"?h.width=l:i.column==="right"&&(h.x=1-l,h.width=l)),l<1&&(i.row==="top"&&l<1?h.y=.5*(.9-l):i.row==="bottom"&&l<1&&(h.y=-.5*(1-l))),this.zedCamera.transformViewport(c,h,t,n)}enableControl(t){this.zedCamera.enableControl(t)}setCameraLimits(t){this.zedCamera.setCameraLimits(t)}setMinMaxDistance(t){this.zedCamera.setMinMaxDistance(t)}}class vr{constructor(t){s(this,"gizmoManager");this.gizmoManager=t}getThingStateEntities(){return ve.getThingStateEntities()}getThingStateEntitiesInFloorplan(t){return ve.getThingStateEntitiesInFloorplan(t)}updateThingState(t,e){ve.updateThingState(t,e)}setHallwayVisibility(t){Ve.setHallwayVisibility(t)}getMovableTransformEntitiesInFloorplan(t){return pe.getMovableTransformEntitiesInFloorplan(t)}updateTransform(t,e,i){pe.updateTransform(t,e,i)}setTransfromGizmo(t){t?(this.gizmoManager.attachableNodes=[t],this.gizmoManager.attachToNode(t)):(this.gizmoManager.attachableNodes=null,this.gizmoManager.attachToNode(null)),b.RenderUpdate()}setEnableDraggingMovable(t){Ue.setEnableDraggingMovable(t)}pickup(t,e){var d;const i=t.getEngine(),n=t.getScene(),a=(d=i._deviceSourceManager)==null?void 0:d._deviceInputSystem,o=e===void 0?qe.Mouse:qe.Touch,l=(o===qe.Mouse,0);o===qe.Touch&&(a._activeTouchIds[l]=e),a._inputs[o]||(a._inputs[o]={}),a._inputs[o][l]||a._addPointerDevice(o,l,0,0);const c=a._inputs[o][l];c[gn.LeftClick]=1,n._inputManager._pointerCaptures[1]=!0,n._inputManager._totalPointersPressed++;const h=t.getBehaviorByName("PointerDrag"),m=h.dragDeltaRatio;h.onDragStartObservable.addOnce(()=>{h.dragDeltaRatio=1,t.position=Ii(h.lastDragPosition)}),h.onDragEndObservable.addOnce(()=>{h.dragDeltaRatio=m}),h.startDrag(1)}async addFurniture(t,e,i,n,a,o){const l=await Dr(t,e,i,n,a,o);return l?l.transformNodes[0]:void 0}getVideoPlayers(){return He.getVideoPlayers()}}const A=(r,t,e)=>{e!==void 0&&r[t]!==void 0&&(r[t]=e)};class br{constructor(){s(this,"postProcess");s(this,"motionBlur");s(this,"replaceCamera",(t,e)=>{var i,n;(i=this.postProcess)==null||i.removeCamera(t),(n=this.postProcess)==null||n.addCamera(e)})}get currentPostprocessSettings(){return jt}dispose(){var t,e;(t=this.postProcess)==null||t.dispose(),(e=this.motionBlur)==null||e.dispose()}setEnablePostprocess(t,e){const i=$e.LastCreatedScene;i&&(t?(this.postProcess||(this.postProcess=new pn("default",!0,i,i.cameras),this.postProcess.automaticBuild=!0,i.enablePrePassRenderer().disableGammaTransform=!0,i.postProcessesEnabled=!0),this.changePostprocessSettings(i,e||jt)):(this.postProcess&&(this.postProcess.imageProcessing.contrast=1,this.postProcess.imageProcessing.exposure=1,this.postProcess.imageProcessing.colorGradingEnabled=!1,this.postProcess.imageProcessing.toneMappingEnabled=!1,this.postProcess.imageProcessing.colorCurvesEnabled=!1,this.postProcess.imageProcessing.vignetteEnabled=!1,this.postProcess.bloomEnabled=!1,this.postProcess.depthOfFieldEnabled=!1,this.postProcess.sharpenEnabled=!1,this.postProcess.chromaticAberrationEnabled=!1),this.motionBlur&&(this.motionBlur.dispose(),this.motionBlur=void 0)),b.RenderUpdate())}changePostprocessSettings(t,e){if(this.postProcess){const a=this.postProcess,o=e.useMSAA!=null&&e.useMSAA?4:1;A(a,"samples",o),A(a,"fxaaEnabled",e.useFXAA),this.postProcess.imageProcessingEnabled=!0;const l=this.postProcess.imageProcessing;if(A(l,"toneMappingEnabled",e.useToneMapping),A(l,"toneMappingType",e.toneMappingType),A(l,"contrast",e.contrast),A(l,"exposure",e.expoure),A(l,"colorCurvesEnabled",e.useColorCurve),e.colorCurveSettings!==void 0){var i=new vn;i.globalDensity=e.colorCurveSettings.globalDensity,i.globalExposure=e.colorCurveSettings.globalExposure,i.globalHue=e.colorCurveSettings.globalHue,i.globalSaturation=e.colorCurveSettings.globalSaturation,i.highlightsDensity=e.colorCurveSettings.highlightsDensity,i.highlightsExposure=e.colorCurveSettings.highlightsExposure,i.highlightsHue=e.colorCurveSettings.highlightsHue,i.highlightsSaturation=e.colorCurveSettings.highlightsSaturation,i.midtonesDensity=e.colorCurveSettings.midtonesDensity,i.midtonesExposure=e.colorCurveSettings.midtonesExposure,i.midtonesHue=e.colorCurveSettings.midtonesHue,i.midtonesSaturation=e.colorCurveSettings.midtonesSaturation,i.shadowsDensity=e.colorCurveSettings.shadowsDensity,i.shadowsExposure=e.colorCurveSettings.shadowsExposure,i.shadowsHue=e.colorCurveSettings.shadowsHue,i.shadowsSaturation=e.colorCurveSettings.shadowsSaturation,l.colorCurves=i}if(A(l,"vignetteEnabled",e.useVignette),A(l,"vignetteWeight",e.vignetteWeight),A(a,"bloomEnabled",e.useBloom),A(a,"bloomKernel",e.bloomKernel),A(a,"bloomScale",e.bloomScale),A(a,"bloomThreshold",e.bloomThreshold),A(a,"bloomWeight",e.bloomWeight),a.depthOfField.isSupported&&(A(a,"depthOfFieldEnabled",e.useDepthOfField),A(a,"depthOfFieldBlurLevel",e.blurLevel),A(a.depthOfField,"fStop",e.fStop),A(a.depthOfField,"focalLength",e.focalLength),A(a.depthOfField,"focusDistance",e.focusDistance),A(a.depthOfField,"lensSize",e.lensSize)),A(a,"chromaticAberrationEnabled",e.useChromaticAberration),A(a.chromaticAberration,"aberrationAmount",e.aberrationAmount),A(a,"sharpenEnabled",e.useSharpen),A(a.sharpen,"edgeAmount",e.edgeAmount),A(a.sharpen,"colorAmount",e.colorAmount),A(l,"colorGradingEnabled",e.useColorGrading),e.useColorGrading&&e.lutTexture!==void 0){if(e.lutIsBlob){var n=new we(e.lutTexture,t,!0,!1,void 0,()=>{b.RenderUpdate()});n.wrapU=we.CLAMP_ADDRESSMODE,n.wrapV=we.CLAMP_ADDRESSMODE,l.colorGradingTexture=n}else if(!l.colorGradingTexture||l.colorGradingTexture.name!==e.lutTexture){const c=e.lutTexture.toLowerCase().endsWith(".3dl"),h=e.lutTexture.toLowerCase().endsWith(".png");if(c)l.colorGradingTexture=new bn(e.lutTexture,t,()=>{b.RenderUpdate()});else if(h){var n=new we(e.lutTexture,t,!0,!1,void 0,()=>{b.RenderUpdate()});n.wrapU=we.CLAMP_ADDRESSMODE,n.wrapV=we.CLAMP_ADDRESSMODE,l.colorGradingTexture=n}else l.colorGradingTexture=null}}e.useMotionBlur?(this.motionBlur||(this.motionBlur=new yn("motion blur",t,1,t.activeCamera),t.clearColor=new Be(25/255,25/255,25/255,0),this.motionBlur.clearColor=new Be(1,1,1,0),b.RenderUpdate(!1),this.motionBlur.onAfterRenderObservable.addOnce(()=>{b.RenderStop()})),A(this.motionBlur,"motionStrength",e.motionStrength),A(this.motionBlur,"samples",1)):this.motionBlur&&(t.clearColor=new Be(0,0,0,0),this.motionBlur.dispose(),this.motionBlur=void 0)}}getReflectorsInFloorplan(t){return ge.getReflectorsInFloorplan(t)}changeReflectorSettings(t,e,i){ge.changeReflectorSettings(t,e,i)}getMaterialChangeableInFloorplan(t){return be.getMaterialChangeableEntitiesInFloorplan(t)}async setMaterialChange(t){await zr(...t)}setResolution(t){b.SetResolution(t)}}class yr{constructor(t){s(this,"scene");s(this,"onBeforeRenderObservable",new K);s(this,"onAfterRenderObservable",new K);s(this,"onPointerUpObservable",new K);s(this,"transformSystem");s(this,"guiUpdateSystem");s(this,"transparentSystem");s(this,"videoPlayerSystem");s(this,"reflectorSystem");s(this,"ceilingSystem");s(this,"pointerDragSystem");s(this,"magnetismSystem");s(this,"magenetismGhostSystem");s(this,"activeHomeSystem");s(this,"openableSystem");s(this,"lightControllerSystem");s(this,"thingStateSystem");s(this,"floorplanSystem");s(this,"hallwaySystem");s(this,"materialChangeSystem");s(this,"cameraTargetSystem");s(this,"structureSystem");s(this,"roomSystem");this.scene=t,this.transformSystem=new pe,this.guiUpdateSystem=new lr,this.transparentSystem=new hr,this.videoPlayerSystem=new He,this.reflectorSystem=new ge,this.ceilingSystem=new dr,this.pointerDragSystem=new Ue,this.magnetismSystem=new fr,this.magenetismGhostSystem=new it,this.activeHomeSystem=new Ce,this.openableSystem=new pr,this.lightControllerSystem=new rt,this.thingStateSystem=new ve,this.floorplanSystem=new se,this.hallwaySystem=new Ve,this.materialChangeSystem=new be,this.cameraTargetSystem=new Pe,this.structureSystem=new ke,this.roomSystem=new oe,this.scene.onBeforeRenderObservable.add(()=>{this.onBeforeRenderObservable.notifyObservers(t)}),this.scene.onAfterRenderObservable.add(()=>{this.onAfterRenderObservable.notifyObservers(t)}),this.scene.onPointerObservable.add(e=>{this.onPointerUpObservable.notifyObservers(e)},L.POINTERUP),this.onBeforeRenderObservable.add(e=>{this.transformSystem.beforeRenderExecute(e),this.thingStateSystem.beforeRenderExecute(e),this.reflectorSystem.beforeRenderExecute(e),this.magnetismSystem.beforeRenderExecute(e),this.magenetismGhostSystem.beforeRenderExecute(e)}),this.onAfterRenderObservable.add(e=>{this.guiUpdateSystem.afterRenderExecute(e),this.transparentSystem.afterRenderExecute(e),this.ceilingSystem.afterRenderExecute(e),this.thingStateSystem.afterRenderExecute(e),this.transformSystem.afterRenderExecute(e)}),this.onPointerUpObservable.add(e=>this.videoPlayerSystem.onPointerUp(e))}reset(){this.scene.onBeforeRenderObservable.clear(),this.onBeforeRenderObservable.clear(),this.scene.onAfterRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.scene.onPointerObservable.clear(),this.onPointerUpObservable.clear(),this.transformSystem.dispose(),this.guiUpdateSystem.dispose(),this.transparentSystem.dispose(),this.videoPlayerSystem.dispose(),this.reflectorSystem.dispose(),this.ceilingSystem.dispose(),this.pointerDragSystem.dispose(),this.magnetismSystem.dispose(),this.magenetismGhostSystem.dispose(),this.activeHomeSystem.dispose(),this.openableSystem.dispose(),this.lightControllerSystem.dispose(),this.thingStateSystem.dispose(),this.floorplanSystem.dispose(),this.hallwaySystem.dispose(),this.materialChangeSystem.dispose(),this.cameraTargetSystem.dispose(),this.structureSystem.dispose(),this.roomSystem.dispose()}}const wt=class{constructor(){s(this,"onUpdateGUIPosition");s(this,"onFirstModelLoaded");s(this,"onAllModelLoaded");s(this,"onModelLoadProgress");s(this,"onEntityStateChanged");s(this,"reset",()=>{this.onUpdateGUIPosition.clear(),this.onFirstModelLoaded.clear(),this.onAllModelLoaded.clear(),this.onModelLoadProgress.clear(),this.onEntityStateChanged.clear()});wt.singletonInstance=this,this.onUpdateGUIPosition=new K,this.onFirstModelLoaded=new K,this.onAllModelLoaded=new K,this.onModelLoadProgress=new K,this.onEntityStateChanged=new K}static get instance(){return this.singletonInstance===void 0&&(this.singletonInstance=new wt),this.singletonInstance}};let z=wt;s(z,"singletonInstance");const ne=class{constructor(t,e,i,n){s(this,"scene");s(this,"engine");s(this,"gizmoManager");s(this,"resizeDelay",-1);s(this,"playingVideoCount",0);s(this,"forceRender",!1);s(this,"getCamera",()=>this.scene.activeCamera);s(this,"reset",()=>{});s(this,"highPerfomance",!0);s(this,"maxFps",60);s(this,"defaultLimitRenderFps",30);s(this,"prevforceRender",!1);s(this,"limitRenderFps",0);s(this,"startManualRenderLoop",()=>{const t=this.scene;var e=Date.now();t&&t.getEngine().runRenderLoop(()=>{const i=!!this.gizmoManager.attachableNodes,n=t.animatables.length>0,a=this.playingVideoCount>0,o=i||n||a||this.forceRender,l=this.isRemainInertia(),c=this.prevforceRender&&!o;let h=o||l||c||this.resizeDelay--===0?this.getTargetFPS():this.limitRenderFps;if(this.initResolution&&this.forceRenderResolution&&(o?this.applyResolution(this.forceRenderResolution):this.applyResolution(this.initResolution)),this.prevforceRender=o,h<=0)return;const m=Date.now(),d=m-e;h=h||60;const f=1e3/h;d>f&&(e=m-d%f,t.render())})});s(this,"renderRequestCount",0);s(this,"runRenderLoop",(t=!1)=>{++this.renderRequestCount,t?(this.limitRenderFps=this.getTargetFPS(),this.scene.onAfterRenderObservable.addOnce(this.stopRenderLoop)):this.limitRenderFps=this.getTargetFPS()});s(this,"stopRenderLoop",()=>{--this.renderRequestCount,this.renderRequestCount<=0&&(this.renderRequestCount=0,this.limitRenderFps=0)});s(this,"enableHighPerfomance",t=>{this.highPerfomance=t});s(this,"getTargetFPS",()=>this.highPerfomance?this.maxFps:this.defaultLimitRenderFps);s(this,"isRemainInertia",()=>{const t=this.getCamera();return t.inertialAlphaOffset!==0||t.inertialBetaOffset!==0||t.inertialPanningX!==0||t.inertialPanningY!==0||t.inertialRadiusOffset!==0});s(this,"initResolution");s(this,"currentResolution");s(this,"forceRenderResolution");s(this,"maxWidth");s(this,"maxHeight");s(this,"hardwareScalingLevel");ne.singletonInstance=this,this.engine=e,this.scene=t,this.gizmoManager=i,n&&new ResizeObserver(a=>{e.resize(),this.resizeDelay=5}).observe(n),this.startManualRenderLoop()}static get instance(){return this.singletonInstance}setResolution(t){if(this.initResolution===t)return;this.initResolution=t;const e=Object.keys(de).flatMap(n=>!isNaN(Number(n))||n=="None"?[]:n),i=e.findIndex(n=>n==de[t.toString()].toString());i===-1?this.forceRenderResolution=void 0:this.forceRenderResolution=de[e[Math.min(i+1,e.length-1)]],this.applyResolution(t),ne.RenderUpdate()}applyResolution(t){if(this.hardwareScalingLevel||(this.hardwareScalingLevel=this.engine.getHardwareScalingLevel()),this.maxWidth||(this.maxWidth=this.engine.getRenderWidth()),this.maxHeight||(this.maxHeight=this.engine.getRenderHeight()),this.currentResolution!==t)if(this.currentResolution=t,t==de.MAX)this.engine.setHardwareScalingLevel(this.hardwareScalingLevel);else if(t==de.NONE)this.engine.setHardwareScalingLevel(1);else{const e=(this.maxWidth>this.maxHeight?this.maxHeight:this.maxWidth)/t;this.engine.setHardwareScalingLevel(Math.max(e*this.hardwareScalingLevel,this.hardwareScalingLevel))}}};let b=ne;s(b,"singletonInstance"),s(b,"RenderUpdate",(t=!0)=>{var e;t?(e=ne.instance)==null||e.runRenderLoop(!0):ne.instance.forceRender=!0}),s(b,"RenderStop",()=>{ne.instance.forceRender=!1}),s(b,"SetResolution",t=>{ne.instance.setResolution(t)});class Ar extends wn{constructor(){super(...arguments);s(this,"ROOMLIGHT",!1)}}class Tr{constructor(){s(this,"roomColor",J.White())}}class wr extends An{constructor(e,i){super(e,"RoomLight",200,new Ar,i);s(this,"colorName");s(this,"_config");s(this,"_isEnabled",!1);this.colorName=e instanceof Tn?"finalColor":"color"}get config(){return this._config}set config(e){this._config!==e&&(this._config=e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(this._isEnabled))}getClassName(){return"RoomLightConfiguration"}prepareDefines(e,i){e.ROOMLIGHT=this._isEnabled}getUniforms(){return{ubo:[{name:"roomColor",size:3,type:"vec3"}],fragment:`#ifdef ROOMLIGHT
                uniform vec3 roomColor;
            #endif`}}bindForSubMesh(e,i){this._isEnabled&&e.updateColor3("roomColor",this.config.roomColor)}getCustomCode(e){return e==="vertex"?this.getVertexCode():this.getFragmentCode()}getVertexCode(){return null}getFragmentCode(){return{CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
      #ifdef ROOMLIGHT
          ${this.colorName}.rgb *= roomColor;
      #endif
    `}}}const Rt=class{constructor(){s(this,"roomLightConfiguration",{});s(this,"roomLightAnimationDuration",.6);s(this,"roomLightAnimationEasingFunction",Ze(ee.QuarticEase,te.Out));Rt.singletonInstance=this,Rn("RoomLightReceiver",t=>(t.roomLight=new wr(t),t.roomLight))}static get instance(){return this.singletonInstance===void 0&&(this.singletonInstance=new Rt),this.singletonInstance}reset(){Cn("RoomLightReceiver"),this.roomLightConfiguration={}}registRoomLightMaterial(t,e){if(e&&e.pluginManager){const i=e.pluginManager.getPlugin("RoomLight");i&&(this.roomLightConfiguration[t]||(this.roomLightConfiguration[t]=new Tr),i.config=this.roomLightConfiguration[t],i.isEnabled=!0)}}setRoomLightAnimationOption(t,e,i){this.roomLightAnimationDuration=t,!(!e||!i)&&(this.roomLightAnimationEasingFunction=Ze(e,i))}setRoomLightColor(t,e,i){if(!this.roomLightConfiguration[t])return;i=i??1;const n=1-.85*(1-i),a=e?new J(n,n,n):new J(.15,.15,.15);D({target:this.roomLightConfiguration[t],property:{targetProperty:"roomColor",keyFrame:{duration:this.roomLightAnimationDuration,from:this.roomLightConfiguration[t].roomColor,to:a}},easingFunction:this.roomLightAnimationEasingFunction},void 0,!0)}};let ye=Rt;s(ye,"singletonInstance");const Rr=r=>{if(!r.videoTexture&&r.src!==""){r.defaultPlay&&b.instance.playingVideoCount++;const t={autoPlay:r.defaultPlay,muted:!1,autoUpdateTexture:!0},e=new On(r.mesh.name,r.src,null,!1,!0,0,t);e.video.volume=.3,e.uScale=1,e.vScale=16/9,e.vOffset=-.4,r.videoTexture=e}},St=r=>{var e;const t=()=>{r&&r.videoTexture&&(r.material.albedoTexture!==r.videoTexture&&(r.material.unfreeze(),r.material.albedoTexture=r.videoTexture,r.material.albedoColor=J.White(),r.material.metallic=.5,r.material.indexOfRefraction=1,r.material.forceCompilation(r.mesh)),r.videoTexture.video.play(),b.instance.playingVideoCount++)};r.initialized?t():(r.initialized=!0,Rr(r),(e=r.videoTexture)==null||e.onLoadObservable.add(()=>t()))},Ai=r=>{var t;r&&((t=r.videoTexture)==null||t.video.pause(),b.instance.playingVideoCount--,b.instance.playingVideoCount<0&&(b.instance.playingVideoCount=0))},Cr=(r,t)=>{r&&r.videoTexture&&(r.videoTexture.video.volume=Math.max(Math.min(1,t),0))};var _=(r=>(r[r.Floor=0]="Floor",r[r.Wall=1]="Wall",r[r.Molding=2]="Molding",r[r.Ceiling=3]="Ceiling",r[r.OutterWall=4]="OutterWall",r[r.Hallway=5]="Hallway",r[r.Builtin=6]="Builtin",r))(_||{}),Oe=(r=>(r[r.Light=0]="Light",r[r.AirConditioner=1]="AirConditioner",r[r.Boiler=2]="Boiler",r[r.Door=3]="Door",r[r.Window=4]="Window",r))(Oe||{});const Ti=r=>{switch(r){case 0:return{isOn:!0,intensity:1};case 1:return{isOn:!1};case 2:return{isOn:!1};case 3:return{isOpen:!1};case 4:return{isOpen:!1}}},Or=(r,t,e,i)=>{const n=[r,t],a=e.getEngine().getRenderingCanvas();if(!a)return n;const o=Mr(e,i,a),l=a.width,c=a.height,h=o.max.x-o.min.x,m=o.max.y-o.min.y,d=.01,f=d*h,u=d*m,v=o.min.x,w=o.max.x,C=o.min.y,x=o.max.y;return r<0&&w+r<=l&&v+r<-f&&(n[0]=0),r>0&&v+r>=0&&w+r>l+f&&(n[0]=0),t<0&&x+t<=c&&C+t<-u&&(n[1]=0),t>0&&C+t>=0&&x+t>c+u&&(n[1]=0),n},Mr=(r,t,e)=>{const i=[],n=r.getWorldExtends();for(let l of[n.min.x,n.max.x])for(let c of[n.min.y,n.max.y])for(let h of[n.min.z,n.max.z]){let m=a(l,c,h,e.width,e.height);i.push(m)}function a(l,c,h,m,d){return g.Project(new g(l,c,h),xe.Identity(),r.getTransformMatrix(),t.viewport.toGlobal(m,d))}const o={min:i[0].clone(),max:i[0].clone()};for(let l of i)l.x<o.min.x&&(o.min.x=l.x),l.y<o.min.y&&(o.min.y=l.y),l.x>o.max.x&&(o.max.x=l.x),l.y>o.max.y&&(o.max.y=l.y);return o},k=(r,t,e)=>{const n=r.getEngine().getRenderingCanvas();if(!n)return;const a=t,o=(a.max.x-a.min.x)*.5,l=(a.max.z-a.min.z)*.5,c=e.fov,h=e.fov*(n.width/n.height),m=o*(1/Math.tan(h*.5)),d=l*(1/Math.tan(c*.5));return(Math.max(m,d)+(a.max.y-a.min.y))*1.1},lt=180/Math.PI,R=Math.PI/180,Er=()=>ke.getStructureMeshesByType(_.Wall),xr=(r,t)=>{for(const e of t){const i=e.getBoundingInfo(),n=new g(r.x,1,r.z);if(i.intersectsPoint(n)){const o=i.boundingBox,l=o.minimumWorld.add(o.maximumWorld).scale(.5);return l.y=1,n.subtract(l).normalize().scale(-1)}}return new g(1,0,0)};let P,E;const zi=(r,t,e,i,n)=>(P||(P=new Ct("covFree",g.Zero(),r)),E||(E=new Ae("convArc",0,0,1,g.Zero(),r)),E.target=t,E.alpha=e===0?.1*R:e,E.beta=i,E.radius=n,E.getWorldMatrix(),P.position=E.position,P.upVector=E.upVector,P.setTarget(t),P.getWorldMatrix(),{pos:P.position,rot:P.rotation}),Li=(r,t,e,i)=>{P||(P=new Ct("covFree",g.Zero(),r)),E||(E=new Ae("convArc",0,0,1,g.Zero(),r)),P.position=t,P.rotation=e,P.getWorldMatrix();const n=P.target.subtract(P.position).normalize(),a=P.position.add(n.scale(i));return E.target=a,E.setPosition(t),E.getWorldMatrix(),{target:E.target,alpha:E.alpha,beta:E.beta,radius:E.radius}};var H=(r=>(r[r.PanZoom=0]="PanZoom",r[r.PanRotate=1]="PanRotate",r[r.RotateZoom=2]="RotateZoom",r[r.RotatePan=3]="RotatePan",r[r.AllAll=4]="AllAll",r[r.AllEach=5]="AllEach",r))(H||{});class Pr{constructor(t){s(this,"seconds");s(this,"easingFunction");s(this,"easingMode");t===void 0&&(t={}),t.seconds===void 0&&(t.seconds=.6),t.easingFunction===void 0&&(t.easingFunction=ee.CircleEase),t.easingMode===void 0&&(t.easingMode=te.Out),this.seconds=t.seconds,this.easingFunction=t.easingFunction,this.easingMode=t.easingMode}}class Jr{constructor(t=0,e=0,i=0,n=!1){s(this,"x");s(this,"y");s(this,"h");s(this,"isRelative");this.x=t,this.y=e,this.h=i,this.isRelative=n}}const re=class{constructor(t){s(this,"angleHor");s(this,"angleVer");s(this,"lowerVerticalAngleLimit",-88);t===void 0&&(t={}),t.angleHor===void 0&&(t.angleHor=0),t.angleVer===void 0&&(t.angleVer=0),this.angleHor=t.angleHor,this.angleVer=t.angleVer,this.angleVer<this.lowerVerticalAngleLimit&&(this.angleVer=this.lowerVerticalAngleLimit)}static convertToVectorFromAlphaBetaRadian(t,e){const i=Math.sin(e-90*R),n=Math.cos(e-90*R),a=n*Math.cos(t),o=n*Math.sin(t);return new g(-a,i,-o).normalize()}getRotatedVectorFrom(t){const[e,i]=this.getRotatedAlphaBetaAsRadianFrom(t);return re.convertToVectorFromAlphaBetaRadian(e,i)}getRotatedAlphaBetaAsRadianFrom(t){let e=0;if(t){let n=t.clone();n.y=0,n=n.normalize(),e=Math.atan2(-n.z,-n.x)*lt}else e=90;e+=this.angleHor,e=(e+360)%360;let i=0;if(t){let n=t.clone().normalize();i=Math.asin(n.y)*lt+90}else i=90;return i-=this.angleVer,i<0&&(i=0),i>180&&(i=180),[e*R,i*R]}};let V=re;s(V,"DOWN",new re({angleHor:0,angleVer:-90})),s(V,"NORTH",new re({angleHor:0,angleVer:0})),s(V,"SOUTH",new re({angleHor:180,angleVer:0})),s(V,"WEST",new re({angleHor:-90,angleVer:0})),s(V,"EAST",new re({angleHor:90,angleVer:0}));class Sr{constructor(t=0,e=0,i=0,n=0){s(this,"x");s(this,"y");s(this,"width");s(this,"height");this.x=t,this.y=e,this.width=i,this.height=n}}const Ee=class{constructor(t){s(this,"engine");s(this,"sceneInstrumentation");s(this,"engineInstrumentation");s(this,"intervalId");s(this,"customDataMap",new Map);s(this,"loadHomeTotal",0);s(this,"itemChanged",!1);s(this,"createInstrumentations",()=>{this.sceneInstrumentation=new Nn(this.scene),this.sceneInstrumentation.captureActiveMeshesEvaluationTime=!0,this.sceneInstrumentation.captureRenderTargetsRenderTime=!0,this.sceneInstrumentation.captureFrameTime=!0,this.sceneInstrumentation.captureRenderTime=!0,this.sceneInstrumentation.captureInterFrameTime=!0,this.sceneInstrumentation.captureParticlesRenderTime=!0,this.sceneInstrumentation.captureSpritesRenderTime=!0,this.sceneInstrumentation.capturePhysicsTime=!0,this.sceneInstrumentation.captureAnimationsTime=!0,this.engineInstrumentation=new Bn(this.scene.getEngine()),this.engineInstrumentation.captureGPUFrameTime=!0});this.scene=t,this.engine=t.getEngine(),this.scene=t}addCustom(t,e,i){this.customDataMap.has(t)||this.customDataMap.set(t,new Map),this.customDataMap.get(t).set(e,i)}registerCallback(t,e){this.intervalId!==void 0&&this.unregisterCallback(),this.sceneInstrumentation===void 0&&this.createInstrumentations(),this.intervalId=setInterval(()=>{var n;const i={fps:this.scene.getEngine().getFps(),meshSelection:this.sceneInstrumentation.activeMeshesEvaluationTimeCounter.lastSecAverage,renderTarget:this.sceneInstrumentation.renderTargetsRenderTimeCounter.lastSecAverage,render:this.sceneInstrumentation.renderTimeCounter.lastSecAverage,frameTotal:this.sceneInstrumentation.frameTimeCounter.lastSecAverage,interFrame:this.sceneInstrumentation.interFrameTimeCounter.lastSecAverage,activeMeshes:this.scene.getActiveMeshes().length,drawCalls:(n=this.sceneInstrumentation)==null?void 0:n.drawCallsCounter.current,vertices:this.scene.getTotalVertices(),resolution:this.engine.getRenderWidth()+" x "+this.engine.getRenderHeight(),loadHomeTotal:this.loadHomeTotal,customInfo:this.customDataMap};t(i,this.itemChanged),this.itemChanged&&(this.itemChanged=!1)},e)}unregisterCallback(){var t,e;this.intervalId!==void 0&&(clearInterval(this.intervalId),this.intervalId=void 0,(t=this.sceneInstrumentation)==null||t.dispose(),this.sceneInstrumentation=void 0,(e=this.engineInstrumentation)==null||e.dispose(),this.engineInstrumentation=void 0)}showInspector(){this.scene.debugLayer.show({showExplorer:!1,initialTab:2})}hideInspector(){this.scene.debugLayer.hide()}};let Me=Ee;s(Me,"instance"),s(Me,"getInstance",t=>(Ee.instance===void 0&&(Ee.instance=new Ee(t)),Ee.instance));class O{static start(t){const e=Date.now();if(!this.list.has(t)){const i=new Error().stack;if(i){const n=i.split(`
`)[2],o=/at\s(.+?)\s.*?\/(.+?)\.ts/g.exec(n);if(o){const l=o[2].toString().split("/"),c=l[l.length-1],h=o[1].toString().split("."),m=h[h.length-1];this.list.set(t,{index:this.index++,callTSFileName:c,callFunctionName:m,start:e})}}}}static end(t){if(this.list.has(t)){let e=this.list.get(t);const i=Date.now();e.total||(e.total=0),e.total+=i-e.start}}static get(t){const e=this.list.get(t);return e!==void 0?e.total:void 0}static toString(){let t=[];return this.list.forEach((e,i)=>{e.total&&t.push(`${e.callTSFileName}.ts => ${e.callFunctionName}(..) => ${i} : ${e.total}ms`)}),t}static print(){const t=this.toString();console.log(t.join(`
`))}static reset(){this.index=0,this.list.clear()}}s(O,"index",0),s(O,"list",new Map);let M,Ot=new Map;const _t="12";let B,Z={},U;var de=(r=>(r[r.MAX=-1]="MAX",r[r.p1440=1440]="p1440",r[r.p1080=1080]="p1080",r[r.p900=900]="p900",r[r.p720=720]="p720",r[r.NONE=0]="NONE",r))(de||{});let _e=new Map,j,Q=new Map;const le="ZED_EXTENSION",_r=async(r,t,e,i)=>{var l;M=r,U=i,at=0,kt=0;const n=Me.getInstance(M);if(U.simpleMode){const c="materials";Ge.OnPluginActivatedObservable.add(h=>{const m=h;m.onParsed=d=>{const f=d.json[c];for(const v of f)v.pbrMetallicRoughness&&(v.pbrMetallicRoughness.baseColorTexture=void 0,v.pbrMetallicRoughness.metallicRoughnessTexture=void 0),v.extras=void 0,v.normalTexture=void 0,v.occlusionTexture=void 0,v.emissiveTexture=void 0,v.emissiveFactor=void 0;const u=d.json.nodes;at+=u.length}})}else Ge.OnPluginActivatedObservable.add(c=>{const h=c;h.onParsed=m=>{if(U.useNormalTexture!==void 0&&!U.useNormalTexture){const u=m.json.materials;for(const v of u)v.normalTexture=void 0}const d=m.json.images;for(const u of d)u.uri&&(u.uri=`${U.textureMaxSize}/${u.uri}`);const f=m.json.nodes;at+=f.length}});if(!B){if(O.start("Data Load - Common"),B=await xt("Zed","Zed_Metadata.json"),!B||B.version!==_t){const[c,h,m]=await Promise.all([Je("/assets/data/Home.json"),Je("/assets/data/HomeFloorPlan.json"),Je("/assets/data/PostProessSettings.json")]);B={version:_t,homeData:c,homeFloorPlanData:h,postProcessSettings:m},await Lt("Zed","Zed_Metadata.json",B)}O.end("Data Load - Common"),n.addCustom("loadHome","Common",O.get("Data Load - Common"))}Nr(B.postProcessSettings),e.setEnablePostprocess(!0,B.postProcessSettings);const a=B.homeData.find(c=>c.homeId===t);if(!a){console.log(`The home does not exist. [homeID : ${t}]`);return}a.ambientColor&&(M.ambientColor=new J(a.ambientColor.r,a.ambientColor.g,a.ambientColor.b)),j=new Mn("",new g(0,-1,0),M),j.intensity=a.lightIntensity??.85,j.name="Standard Only Light",j.includedOnlyMeshes=[],M.environmentTexture=Fr(M,`${a.environmentTexture??"default.env"}`),M.environmentIntensity=1;const o=B.homeFloorPlanData.filter(c=>c.homeId===t);if(o.length===0){console.log(`The floor plan does not exist for that home. [homeID : ${t}]`);return}if(!Z[t]){if(O.start("Data Load - FloorPlan"),Z[t]=await xt("User",`Zed_${t}.json`),!Z[t]&&B.version===_t&&(Z[t]=await xt("Zed",`Zed_${t}.json`)),!Z[t]){if(Z[t]=await Promise.all(o.map(c=>Je(`/assets/floorplan/${c.floorplanId}.json`))),!Z[t])return;await Lt("Zed",`Zed_${t}.json`,Z[t])}O.end("Data Load - FloorPlan"),n.addCustom("loadHome","FloorPlan",O.get("Data Load - FloorPlan"))}o.forEach(c=>{const h=o.find(d=>d.floorplanId===c.floorplanId),m=h?Ii(h.position):g.Zero();Ot.set(c.floorplanId,m)}),O.start("Model Load"),M.blockfreeActiveMeshesAndRenderingGroups=!0;for(const c of Z[t]){const h=c.floorplanId,m=new Ci(h,M);m.rotation=new g(0,$.FromDegrees(180).radians(),0),m.scaling=new g(1,1,-1);const d=`/assets/model/${c.floorplanId}_${U.modelLOD}.glb`,f=g.Zero(),u=0,v=g.One(),w=[...new Set((l=c.materialOverrideData)==null?void 0:l.map(C=>C.materialName))];Se.RegisterExtension(le,C=>new Gt(C,t,h)),await Promise.all([Wt(m,h,h,d,f,u,v),...c.furniturePlaceData.map(C=>{const x=C.name,Ye=`/assets/model/${x}_${U.modelLOD}.glb`;let ie=Vt(C.position),Te=Fi(C.rotationY);Te=$.FromDegrees(Te%360).radians();let Ke=Vt(C.scale);return Wt(m,h,x,Ye,ie,Te,Ke)}),...w.map(C=>{const x=`/assets/model/${C}_${U.modelLOD}.glb`;return Ni(C,x)})]),Se.UnregisterExtension(le),Lr(h,c.materialOverrideData),oe.updateRoomInFloorplan(h)}M.blockfreeActiveMeshesAndRenderingGroups=!1,O.end("Model Load"),n.addCustom("loadHome","Model Load",O.get("Model Load")),O.start("Shader Compile"),await Promise.all(M.meshes.map(c=>{var h;return(h=c.material)==null?void 0:h.forceCompilationAsync(c)})),O.end("Shader Compile"),n.addCustom("loadHome","Shader Compile",O.get("Shader Compile")),z.instance.onAllModelLoaded.hasObservers()&&z.instance.onAllModelLoaded.notifyObservers(void 0),b.RenderUpdate()};let kt=0,at=0;const Ir="__root__",ct=".",Bi=["gltf","glb"],Wt=async(r,t,e,i,n,a,o)=>{try{let l;i=i.trim();const c=i.split(ct).pop();if(c&&!Bi.includes(c.toLowerCase())){console.log(`.${c} file format is not supported`);return}l=await Ge.ImportMeshAsync("",i,void 0,M,void 0,`${ct}${c}`);const h=l.meshes.filter(f=>f.name!==Ir);let m=l.transformNodes.find(f=>f.name.includes(e)),d=!m;if(d&&(m=h.find(f=>f.name.includes(e))),m){const f=Ot.get(t)??g.Zero();m.setAbsolutePosition(f.add(n)),m.rotation=new g(0,a,0),m.scaling=o;const u=m.parent;let v;d?(v=new Ci(m.name,M),m.parent=v):v=m,v.parent=r,u&&u.dispose(!1,!1)}else console.log(` modelName TransformNode or Mesh   . root   . modelName: [${e}]`);return l}catch{}},Fr=(r,t,e)=>{let i=_e.get(t);if(!i){const n=`/assets/environment/${t}`;i=Oi.CreateFromPrefilteredData(n,r),i.gammaSpace=!1,_e.set(t,i)}return e&&i.level!=e&&(i.level=e),i},Dr=async(r,t,e,i,n,a)=>{if(!M)return;const o=M.getTransformNodeByName(t);if(!o)return;const l=`/assets/model/${e}_${U.modelLOD}.glb`;Se.RegisterExtension(le,h=>new Gt(h,r,t));const c=await Wt(o,t,e,l,i??o.position,n??0,a??g.One());if(Se.UnregisterExtension(le),!!c)return await Promise.all(c.meshes.map(h=>{var m;return(m=h.material)==null?void 0:m.forceCompilationAsync(h)})),b.RenderUpdate(),c},Ni=async(r,t)=>{try{if(Q.has(r))return;t=t.trim();const e=t.split(ct).pop();if(e&&!Bi.includes(e.toLowerCase())){console.log(`.${e} file format is not supported`);return}(await Ge.ImportMeshAsync("",t,void 0,M,void 0,`${ct}${e}`)).meshes.forEach(n=>n.dispose(!1,!1))}catch{}},zr=async(r,t)=>{const e=r.Identifier.homeId,i=r.Identifier.floorplanId,n=t.materialName;if(!Q.has(n)){Se.RegisterExtension(le,o=>new Gt(o,e,i));const a=`/assets/model/${n}_${U.modelLOD}.glb`.trim();await Ni(n,a),Se.UnregisterExtension(le)}await Hi(r,t)},Lr=(r,t)=>{if(!t)return;const e=be.getMaterialChangeableEntitiesInFloorplan(r);for(const i of e){const n=i.TransformNode.name,a=t.filter(o=>o.name===n);for(let o=0;o<a.length;o++){const l=a[o];Hi(i,l)}}},Hi=async(r,t)=>{const i=r.Structure.structureType===_.Floor,n=r.Structure.meshes;if(t.index>=n.length)return;const a=n[t.index],o=t.materialName,l=a.material;if(!l||l.name===o||!(l instanceof et||l instanceof ue))return;const c=Q.get(o);if(!c||!(c instanceof et||c instanceof ue))return;const h=c.clone(o);if(h instanceof ue?h.reflectionTexture=l.reflectionTexture:h instanceof et&&(i||(h.reflectionTexture=null),j&&j.includedOnlyMeshes.push(a)),h.lightmapTexture=l.lightmapTexture,h.useLightmapAsShadowmap=!0,a.material=h,l.dispose(!1,!1),await a.material.forceCompilationAsync(a),b.RenderUpdate(),r.MaterialChangeable.materialData.find(d=>d.name===t.name&&d.index===t.index&&d.materialName===t.materialName)){const d=r.MaterialChangeable.materialOverrideData.findIndex(f=>f.name===t.name&&f.index===t.index);d!==-1&&r.MaterialChangeable.materialOverrideData.splice(d)}else{const d=r.MaterialChangeable.materialOverrideData.findIndex(f=>f.name===t.name&&f.index===t.index);d!==-1?r.MaterialChangeable.materialOverrideData[d]=t:r.MaterialChangeable.materialOverrideData.push(t)}},Br=()=>{Ge.OnPluginActivatedObservable.clear(),M=void 0,Ot.clear(),j&&j.dispose(!1,!0),j=void 0,_e.forEach(r=>{r&&r.dispose()}),_e.clear(),Q.clear()};class Gt{constructor(t,e,i){s(this,"name",le);s(this,"enabled");s(this,"loader");s(this,"homeId");s(this,"floorplanId");s(this,"lightmap",new Map);s(this,"entities",[]);this.loader=t,this.enabled=t.isExtensionUsed(le),this.homeId=e,this.floorplanId=i}dispose(){this.lightmap.clear(),this.entities=[],this.loader=null}async loadSceneAsync(t,e){if(e.extras&&e.extras.floorplan){const i=ui({Identifier:{homeId:this.homeId,floorplanId:this.floorplanId}});p.addComponent(i,"Floorplan",{extends:e.extras.floorplan.extends,pivotPosition:Ot.get(this.floorplanId)??g.Zero()}),this.entities.push(i)}await this.loader.loadSceneAsync(t,e)}async loadNodeAsync(t,e,i){await this.loader.loadNodeAsync(t,e,i),kt===0&&z.instance.onFirstModelLoaded.hasObservers()&&z.instance.onFirstModelLoaded.notifyObservers(void 0),z.instance.onModelLoadProgress.hasObservers()&&z.instance.onModelLoadProgress.notifyObservers(++kt/at);const n=e._babylonTransformNode,a=e._primitiveBabylonMeshes;if(n&&(a&&this.optimizeMeshes(a),e.extras)){const l=ui({Identifier:{homeId:this.homeId,floorplanId:this.floorplanId},TransformNode:n}),c=e.extras.material,h=e.extras.structure;if((c||h)&&a){if(c&&c.reflection||h&&h.reflection)for(const d of a){const f=d.material,u=new et(f.name,M);u.diffuseColor=f.albedoColor,f.albedoTexture&&(u.diffuseTexture=f.albedoTexture),f.bumpTexture&&(u.bumpTexture=f.bumpTexture),f.ambientTexture&&(u.ambientTexture=f.ambientTexture),f.lightmapTexture&&(u.lightmapTexture=f.lightmapTexture,u.useLightmapAsShadowmap=!0),u.specularColor=J.Black(),U.reflection&&(u.reflectionTexture=ge.getReflectionTexture(this.floorplanId)),u.ambientColor=J.White(),d.material=u,Q.has(f.name)||Q.set(u.name,u),f.dispose(!1,!1),h&&j&&j.includedOnlyMeshes.push(d)}else if(c)for(const d of a){const f=d.material;Q.has(f.name)||Q.set(f.name,f)}else if(h){const d=h.structureType;if(d===_.Floor||d===_.Wall)for(const f of a){const u=f.material;Q.has(u.name)||Q.set(u.name,u)}}}if(h&&a){const d=h.structureType;if(d!==_.Builtin&&p.addComponent(l,"Structure",{structureType:d,meshes:a}),d===_.Floor||d===_.Wall){const f=[];for(let u=0;u<a.length;u++){const v=a[u].material;v&&f.push({name:n.name,materialName:v.name,index:u})}p.addComponent(l,"MaterialChangeable",{materialData:f,materialOverrideData:[]})}d===_.Floor?(p.addComponent(l,"Room",{extends:n.getHierarchyBoundingVectors(),viewDataList:h.viewDataList}),p.addComponent(l,"ThingState",{type:Oe.Light,state:Ti(Oe.Light)}),p.addComponent(l,"GUIDisplayable",!0),p.addComponent(l,"CameraTarget",!0),p.addComponent(l,"LightController",!0),p.addComponent(l,"MagnetismTarget",!0)):d===_.Wall?p.addComponent(l,"MagnetismTarget",!0):d===_.OutterWall?p.addComponent(l,"Transparentable",!0):d===_.Ceiling?p.addComponent(l,"Ceiling",!0):d===_.Hallway&&p.addComponent(l,"Hallway",!0),d!==_.OutterWall&&d!==_.Hallway&&p.addComponent(l,"RoomObject",{})}const m=e.extras.furniture;if(m&&n){if(m.moveable){const d=m.magneticFace;p.addComponent(l,"TransformMovable",{magnetismFixtureFace:d})}if(m.video){let d=n.getChildTransformNodes().find(u=>u.name==m.video.target);d||(d=n);const f=d.getChildMeshes();if(f.length>m.video.index){const u=f[m.video.index];p.addComponent(l,"VideoPlayer",{initialized:!1,src:"/assets/video/zigbang.mp4",mesh:u,material:u.material,defaultPlay:!1})}}if(m.thingType&&m.thingType>=0){const d=m.thingType;if(p.addComponent(l,"ThingState",{type:d,state:Ti(d)}),p.addComponent(l,"GUIDisplayable",{displayName:n.name}),p.addComponent(l,"CameraTarget",{}),(d===Oe.Door||d===Oe.Window)&&e.extras.furniture.animation){const f=n.getChildTransformNodes().find(u=>u.name==e.extras.furniture.animation.target);if(f){const u=e.extras.furniture.animation;p.addComponent(l,"Openable",{target:f,openPosition:new g(-u.openPosition.x,u.openPosition.y,-u.openPosition.z),closePosition:new g(-u.closePosition.x,u.closePosition.y,-u.closePosition.z),openRotation:new g($.FromDegrees(-u.openRotation.x).radians(),$.FromDegrees(-u.openRotation.y).radians(),$.FromDegrees(-u.openRotation.z).radians()),closeRotation:new g($.FromDegrees(-u.closeRotation.x).radians(),$.FromDegrees(-u.closeRotation.y).radians(),$.FromDegrees(-u.closeRotation.z).radians())})}}}p.addComponent(l,"ReflectionTarget",!0),p.addComponent(l,"RoomObject",{})}this.entities.push(l)}}optimizeMeshes(t){for(const e of t)e.freezeWorldMatrix(),e.doNotSyncBoundingInfo=!0,e.isPickable=!1,e.alwaysSelectAsActiveMesh=!1}async loadMaterialPropertiesAsync(t,e,i){await this.loader.loadMaterialPropertiesAsync(t,e,i);const n=`${t}/commonConstant`;if(i instanceof ue&&(i.albedoColor.r=Math.max(0,Math.min(i.albedoColor.r,1)),i.albedoColor.g=Math.max(0,Math.min(i.albedoColor.g,1)),i.albedoColor.b=Math.max(0,Math.min(i.albedoColor.b,1)),i.alphaCutOff=.5,i.maxSimultaneousLights=1,e.extras)){if(e.extras.lightmapTexture){const a=e.extras.lightmapTexture,o=a.index??-1;o>=0&&(i.lightmapTexture=this.lightmap.get(o)??await this.loader.loadTextureInfoAsync(`${n}/lightmapTexture`,a,l=>{l.level=o.lightmapLevel??1,this.lightmap.set(o,l)}),i.useLightmapAsShadowmap=!0),i.ambientColor=J.White()}if(e.extras.reflectionProbe){const a=$e.LastCreatedScene;if(a){const o=`${e.extras.reflectionProbe.name}.env`;let l=_e.get(o);if(!l){const c=`/assets/environment/${o}`;l=Oi.CreateFromPrefilteredData(c,a),l.gammaSpace=!1,_e.set(o,l);const h=e.extras.reflectionProbe.intensity;h&&l.level!=h&&(l.level=h)}i.reflectionTexture=l}}}e.extras}onReady(){}}let jt={useMSAA:!0,useFXAA:!0,useToneMapping:!0,toneMappingType:En.Hable,contrast:1.75,expoure:1.35,useColorGrading:!1,lutTexture:"",useColorCurve:!1,colorCurveSettings:{globalDensity:0,globalExposure:0,globalHue:30,globalSaturation:0,highlightsDensity:0,highlightsExposure:0,highlightsHue:30,highlightsSaturation:0,midtonesDensity:0,midtonesExposure:0,midtonesHue:30,midtonesSaturation:0,shadowsDensity:0,shadowsExposure:0,shadowsHue:30,shadowsSaturation:0},useBloom:!1,bloomKernel:64,bloomScale:.5,bloomThreshold:.9,bloomWeight:.15,useDepthOfField:!1,blurLevel:xn.Low,fStop:1.4,focalLength:50,focusDistance:2e3,lensSize:50,useVignette:!0,vignetteWeight:1.05,useChromaticAberration:!1,aberrationAmount:10,useSharpen:!1,edgeAmount:.3,colorAmount:1,useMotionBlur:!1,motionStrength:1};const Nr=r=>{jt=r},$t=class extends Pn{constructor(){super();s(this,"swapPanAndRotate",!0);s(this,"camera",new Ae("",0,0,0,new g));s(this,"buttons",[0,1,2]);s(this,"angularSensibilityX",1e3);s(this,"angularSensibilityY",1e3);s(this,"pinchPrecision",12);s(this,"pinchDeltaPercentage",0);s(this,"useNaturalPinchZoom",!1);s(this,"pinchZoom",!0);s(this,"panningSensibility",1e3);s(this,"multiTouchPanning",!0);s(this,"multiTouchPanAndZoom",!0);s(this,"pinchInwards",!0);s(this,"_isPanClick",!1);s(this,"_twoFingerActivityCount",0);s(this,"_isPinching",!1);s(this,"startA",{x:0,y:0});s(this,"startB",{x:0,y:0})}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,i){if(this.panningSensibility!==0&&e&&i){const n=i.x-e.x,a=i.y-e.y;if(this.swapPanAndRotate)this.camera.inertialAlphaOffset-=n/this.angularSensibilityX,this.camera.inertialBetaOffset-=a/this.angularSensibilityX;else{const[o,l]=this.checkIsPanPossible(n,a);this.camera.inertialPanningX+=-o/this.panningSensibility,this.camera.inertialPanningY+=l/this.panningSensibility}}}_computePinchZoom(e,i){const n=this.camera.radius||$t.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=n*Math.sqrt(e)/Math.sqrt(i):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(i-e)*.001*n*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(i-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,i,n){if(this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)){const[a,o]=this.checkIsPanPossible(i,n);this.camera.inertialPanningX+=-a/this.panningSensibility,this.camera.inertialPanningY+=o/this.panningSensibility,b.RenderUpdate()}else if(this.swapPanAndRotate){const[a,o]=this.checkIsPanPossible(i,n);this.camera.inertialPanningX+=-a/this.panningSensibility,this.camera.inertialPanningY+=o/this.panningSensibility,b.RenderUpdate()}else this.camera.inertialAlphaOffset-=i/this.angularSensibilityX,this.camera.inertialBetaOffset-=n/this.angularSensibilityY,b.RenderUpdate()}checkIsPanPossible(e,i){return[e,i]}onDoubleTap(){this.camera.useInputToRestoreState&&(this.camera.restoreState(),b.RenderUpdate())}onMultiTouch(e,i,n,a,o,l){if(!(n===0&&o===null)&&!(a===0&&l===null))if(this.multiTouchPanAndZoom)this._computePinchZoom(n,a),this._computeMultiTouchPanning(o,l),b.RenderUpdate();else if(this.multiTouchPanning&&this.pinchZoom){if(this._twoFingerActivityCount++,e&&i){if(this._twoFingerActivityCount<=1)this.startA.x=e.x,this.startA.y=e.y,this.startB.x=i.x,this.startB.y=i.y,this._isPinching=!0;else if(2<=this._twoFingerActivityCount&&this._twoFingerActivityCount<=10){const c=[e.x-this.startA.x,e.y-this.startA.y],h=[i.x-this.startB.x,i.y-this.startB.y],m=c[0]*h[0]+c[1]*h[1];this._isPinching=m<=0}}this._isPinching?(this._computePinchZoom(n,a),b.RenderUpdate()):(this._computeMultiTouchPanning(o,l),b.RenderUpdate())}else this.multiTouchPanning?(this._computeMultiTouchPanning(o,l),b.RenderUpdate()):this.pinchZoom&&(this._computePinchZoom(n,a),b.RenderUpdate())}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}};let We=$t;s(We,"MinimumRadiusForPinch",.001);Mi.ArcRotateCameraPointersInput=We;class Ui{constructor(t){s(this,"scene");s(this,"moveAnimationTargetCameraWithArcRotate",async(t,e,i,n,a,o)=>{const{pos:l,rot:c}=zi(this.scene,e,i,n,a);o<=0?(t.target=e,t.position=l,t.upVector=new g(0,1,0)):await D({target:t,property:[{targetProperty:"position",keyFrame:{duration:o,from:t.position,to:l}},{targetProperty:"rotation",keyFrame:{duration:o,from:t.rotation,to:c}},{targetProperty:"upVector",keyFrame:{duration:o,from:t.upVector,to:new g(0,1,0)}}],easingFunction:this.getEasingFunction(),onAnimationEnd:()=>{}},this.scene)});s(this,"moveAnimationTargetCamera",async(t,e,i,n)=>{n<=0?(t.position=e,t.rotation=i):await D({target:t,property:[{targetProperty:"position",keyFrame:{duration:n,from:t.position,to:e}},{targetProperty:"rotation",keyFrame:{duration:n,from:t.rotation,to:i}}],easingFunction:this.getEasingFunction(),onAnimationEnd:()=>{}},this.scene)});s(this,"moveAnimation",async(t,e,i,n,a,o)=>{this.resetInertia(t);const l=c=>(c>Math.PI&&(c-=2*Math.PI),c<-Math.PI&&(c+=2*Math.PI),c);o<=0?(t.target=e,t.alpha=l(i),t.beta=n,t.radius=a):await D({target:t,property:[{targetProperty:"target",keyFrame:{duration:o,from:t.target,to:e}},{targetProperty:"alpha",keyFrame:{duration:o,from:l(t.alpha),to:l(i)}},{targetProperty:"beta",keyFrame:{duration:o,from:t.beta,to:n}},{targetProperty:"radius",keyFrame:{duration:o,from:t.radius,to:a}}],easingFunction:this.getEasingFunction(),onAnimationEnd:()=>{}},this.scene)});s(this,"changeAlphaWithAnimation",(t,e,i)=>{this.resetInertia(i),D({target:i,property:{targetProperty:"alpha",keyFrame:{duration:.2,from:t,to:e}},easingFunction:this.getEasingFunction()},this.scene)});s(this,"positionAnimation",(t,e,i,n)=>{D({target:t,property:[{targetProperty:"position",keyFrame:{duration:i,from:t.position,to:e}},{targetProperty:"target",keyFrame:{duration:i,from:t.target,to:t.target}}],easingFunction:this.getEasingFunction()},this.scene,n)});s(this,"zoomAnimation",(t,e,i,n,a)=>{this.resetInertia(t),D({target:t,property:[{targetProperty:"radius",keyFrame:{duration:n,from:t.radius,to:e}},{targetProperty:"target",keyFrame:{duration:n,from:t.target,to:i}}],easingFunction:this.getEasingFunction()},this.scene,a)});s(this,"viewportAnimation",(t,e,i,n,a)=>{D({target:t.viewport,property:[{targetProperty:"x",keyFrame:{duration:n,from:e.x,to:i.x}},{targetProperty:"y",keyFrame:{duration:n,from:e.y,to:i.y}},{targetProperty:"width",keyFrame:{duration:n,from:e.width,to:i.width}},{targetProperty:"height",keyFrame:{duration:n,from:e.height,to:i.height}}],onAnimationEnd:a},this.scene)});s(this,"resetInertia",t=>{t.inertialAlphaOffset=0,t.inertialBetaOffset=0,t.inertialPanningX=0,t.inertialPanningY=0});s(this,"easingFunction");s(this,"getEasingFunction",()=>this.easingFunction);s(this,"setEasingFunction",(t,e)=>{this.easingFunction=Ze(t,e)});this.scene=t,this.easingFunction=new zt,this.easingFunction.setEasingMode(ze.EASINGMODE_EASEOUT)}static async toOtherCameraState(t,e,i,n){const a=ot(n),o=nt("position",q.ANIMATIONTYPE_VECTOR3);o.setKeys([{frame:0,value:t.position},{frame:a,value:e.position}]),t.animations.push(o);const l=nt("fov",q.ANIMATIONTYPE_FLOAT);l.setKeys([{frame:0,value:t.fov},{frame:a,value:e.fov}]),t.animations.push(l);const c=nt("rotation",q.ANIMATIONTYPE_VECTOR3),h=t.rotation,m=e.rotationQuaternion.toEulerAngles();m.y<0&&(m.y+=360*R),c.setKeys([{frame:0,value:h},{frame:a,value:m}]),t.animations.push(c),await i.beginAnimation(t,0,ot(n),!1).waitAsync()}}Sn.AddNodeConstructor("DeviceOrientationCamera",(r,t)=>()=>new Vi(r,g.Zero(),t));class Vi extends Ct{constructor(e,i,n){super(e,i,n);s(this,"_initialQuaternion");s(this,"_quaternionCache");s(this,"_tmpDragQuaternion",new W);s(this,"_disablePointerInputWhenUsingDeviceOrientation",!0);s(this,"_customInput");s(this,"addCallbackToCustomInput",()=>{this._customInput&&this._customInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(e=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new W),W.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})});s(this,"_dragFactor",0);this._quaternionCache=new W,this.inputs.addDeviceOrientation()}addCustomInput(e){this._customInput=e,this.inputs.add(e),this.addCallbackToCustomInput()}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=_n.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new W),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(i=>{e[i]?this._initialQuaternion[i]*=-1:this._initialQuaternion[i]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class ki{constructor(t){s(this,"_camera");s(this,"_screenOrientationAngle",0);s(this,"_constantTranform");s(this,"_screenQuaternion",new W);s(this,"_initAlpha",0);s(this,"_alpha",0);s(this,"_beta",0);s(this,"_gamma",0);s(this,"smoothFactor",0);s(this,"_onDeviceOrientationChangedObservable",new K);s(this,"_orientationChanged",()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-T.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))});s(this,"_promiseResolve");s(this,"_adjustAlpha",0);s(this,"_count",0);s(this,"_deviceOrientation",t=>{t.alpha&&this._count<10&&this._count++,this._count===1&&t.alpha&&(this._adjustAlpha=t.alpha);const e=t.alpha===null?null:t.alpha-this._adjustAlpha+.01;this.smoothFactor?(this._alpha=e!==null?T.SmoothAngleChange(this._alpha,e,this.smoothFactor):0,this._beta=t.beta!==null?T.SmoothAngleChange(this._beta,t.beta,this.smoothFactor):0,this._gamma=t.gamma!==null?T.SmoothAngleChange(this._gamma,t.gamma,this.smoothFactor):0):(this._alpha=e!==null?(e+360)%360:0,this._beta=t.beta!==null?t.beta:0,this._gamma=t.gamma!==null?t.gamma:0),t.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers(),this._count===2&&t.alpha&&this._promiseResolve&&(this.checkInputs(),this._promiseResolve([e,t.beta,t.gamma]),this._promiseResolve=void 0)});if(t){const e=t.normalize();this._initAlpha=(Math.atan2(e.z,e.x)*lt-90+360)%360}this._constantTranform=new W(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}static WaitForOrientationChangeAsync(t){return new Promise((e,i)=>{let n=!1;const a=()=>{window.removeEventListener("deviceorientation",a),n=!0,e()};t&&setTimeout(()=>{n||(window.removeEventListener("deviceorientation",a),i("WaitForOrientationChangeAsync timed out"))},t),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(o=>{o=="granted"?window.addEventListener("deviceorientation",a):T.Warn("Permission not granted.")}).catch(o=>{T.Error(o)}):window.addEventListener("deviceorientation",a)})}get camera(){return this._camera}set camera(t){this._camera=t,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new W),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const t=this.camera.getScene().getEngine().getHostWindow();if(t){const e=()=>{t.addEventListener("orientationchange",this._orientationChanged),t.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?e():T.Warn("Permission not granted.")}).catch(i=>{T.Error(i)}):e()}}async getGyroAngles(){return new Promise((t,e)=>{this._promiseResolve=t})}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(W.RotationYawPitchRollToRef(T.ToRadians((this._initAlpha+this._alpha)%360),T.ToRadians(this._beta),-T.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}Mi.FreeCameraDeviceOrientationInput=ki;const Qt=class{constructor(t){s(this,"scene");s(this,"animationHelper");s(this,"currentEasingFunctionType",ee.CircleEase);s(this,"currentEasingMode",te.Out);s(this,"defaultTarget",g.Zero());s(this,"defaultRadius",3);s(this,"defaultAlpha",90*R);s(this,"defaultBeta",0);s(this,"defaultFov",.8);s(this,"fitRadiusWithMargin",12);s(this,"ext");this.scene=t,this.animationHelper=new Ui(this.scene)}reset(){}copyFromCamera(t){const e=t.babylonCamera(),i=this.babylonCamera();if(e.getWorldMatrix(),i instanceof Ae){const n=e.getTarget().subtract(e.position).length();i.lowerRadiusLimit&&n<i.lowerRadiusLimit&&(i.lowerRadiusLimit=n,Qt.minDistance=n)}else i.upVector=e.upVector;i.fov=e.fov,i.position=e.position,i.setTarget(e.getTarget()),i.getWorldMatrix()}setActive(){this.scene.activeCamera=this.babylonCamera()}initWithExtends(t,e=!0,i=.3){this.ext=t,this.defaultTarget.x=(t.min.x+t.max.x)*.5,this.defaultTarget.y=t.min.y,this.defaultTarget.z=(t.min.z+t.max.z)*.5;const n=k(this.scene,t,this.babylonCamera());if(!n)return;const a=this.babylonCamera();a.getWorldMatrix();const o=Li(this.scene,a.position,a.rotation,a.target.subtract(a.position).length()),l=e?this.defaultAlpha:o.alpha,c=e?this.defaultBeta:o.beta;this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),this.defaultTarget,l,c,n,i)}renderApply(){b.RenderUpdate()}topFit(t){const e=this.babylonCamera(),i=e.position.subtract(this.defaultTarget).length(),{pos:n,rot:a}=zi(this.scene,this.defaultTarget,this.defaultAlpha,this.defaultBeta,i);e.fov=this.defaultFov,e.position=n,e.setTarget(this.defaultTarget),this.zoomFit(!0,t)}setCameraLimits(t=!0){}setMinMaxDistance(t){}isRemainInertia(){return!1}quaterView(t=45,e=45,i){const n=t*R,a=e*R,o=this.fitRadiusWithMargin;this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),this.defaultTarget,n,a,o,i)}quaterViewFit(t=45,e=45,i,n,a){const o=t*R,l=e*R,c=k(this.scene,a,this.babylonCamera()),h=1+(100-n)/100;c!==void 0&&this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),this.defaultTarget,o,l,c*h,i)}zoomIn(t=30,e=.3){if(t<0)return;const i=this.babylonCamera();i.getWorldMatrix();const n=i.position.clone(),a=i.target.clone(),o=n.subtract(a).normalize(),c=n.subtract(a).length()*(1-t/100),h=a.add(o.scale(c));this.animationHelper.positionAnimation(i,h,e)}zoomOut(t=30,e=.3){if(t<0)return;const i=this.babylonCamera();i.getWorldMatrix();const n=i.position.clone(),a=i.target.clone(),o=n.subtract(a).normalize(),c=n.subtract(a).length()*(1+t/100),h=a.add(o.scale(c));this.animationHelper.positionAnimation(i,h,e)}setDistance(t=3,e=.3){const i=this.babylonCamera();i.getWorldMatrix();const n=i.position.clone(),a=i.target.clone(),o=n.subtract(a).normalize(),l=a.add(o.scale(t));this.animationHelper.positionAnimation(i,l,e)}zoomFitOnInit(t){}zoomFit(t=!1,e){const i=k(this.scene,e,this.babylonCamera());if(i===void 0)return;const n=this.babylonCamera();n.getWorldMatrix(),n.target=this.defaultTarget;const a=n.position.clone(),o=n.target.clone(),l=a.subtract(o).normalize(),c=o.add(l.scale(i));this.animationHelper.positionAnimation(n,c,.4),t?this.animationHelper.positionAnimation(n,c,.4):n.position=c}async moveTo(t,e,i=!1,n=1){let a=new g(0,0,-1);i&&(a=this.babylonCamera().target.subtract(this.babylonCamera().position).normalize());const[o,l]=e.getRotatedAlphaBetaAsRadianFrom(a),c=V.convertToVectorFromAlphaBetaRadian(o,l),h=new g(-t.x,t.h,-t.y);this.babylonCamera().getWorldMatrix();let m=this.babylonCamera().target.clone(),d=this.babylonCamera().position.clone();t.isRelative?(d=this.babylonCamera().position.add(h),m=d.subtract(c.scale(-1))):(m=h.add(c),d=m.subtract(c)),g.Distance(d,m),await this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),m,o,l,1,n)}async moveToCameraTarget(t,e,i,n,a=1,o=!0){const l=o?e.clone().normalize().scale(-1):new g(0,0,-1),[c,h]=i.getRotatedAlphaBetaAsRadianFrom(l),m=t;await this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),m,c,h,n,a)}async moveToCoordinate(t,e,i=1){await this.animationHelper.moveAnimationTargetCamera(this.babylonCamera(),t,e,i)}topViewFit(t=.3,e){const i=this.defaultTarget,n=k(this.scene,e,this.babylonCamera());n!==void 0&&this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),i,this.defaultAlpha,this.defaultBeta,n,t)}topViewCustom(t,e,i,n,a=.3,o){if(i<=0)return;const l=this.defaultTarget,c=new g(l.x-t,l.y,l.z-e),h=k(this.scene,o,this.babylonCamera());if(h===void 0)return;const m=1+(100-i)/100;this.animationHelper.moveAnimationTargetCameraWithArcRotate(this.babylonCamera(),c,this.defaultAlpha+n*R,this.defaultBeta,h*m,a)}setEasingFunction(t,e){t===this.currentEasingFunctionType&&e===this.currentEasingMode||(this.currentEasingFunctionType=t,this.currentEasingMode=e,this.animationHelper.setEasingFunction(t,e))}getCurrentEasingSetting(){return[this.currentEasingFunctionType,this.currentEasingMode]}setViewport(t){Object.assign(this.babylonCamera().viewport,t)}getViewport(){return this.babylonCamera().viewport}transformViewport(t,e,i,n){this.animationHelper.viewportAnimation(this.babylonCamera(),t,e,i,n)}enableControl(t){this.babylonCamera().inputs.removeByType("FreeCameraMouseInput"),t&&this.babylonCamera().inputs.add(new In)}moveToPosition(t,e){const i=this.babylonCamera();t&&(i.position=new g(t.x,1.6,t.z),e&&i.setTarget(i.position.add(e.normalize())))}};let F=Qt;s(F,"minDistance",1),s(F,"maxDistance",null);class wi extends F{constructor(e){super(e);s(this,"camera");this.camera=new Ct("free",g.Zero(),this.scene),this.camera.fov=1.2,this.camera.inertia=0,this.camera.minZ=.1,this.camera.attachControl(void 0,!0)}babylonCamera(){return this.camera}}class It extends F{constructor(e,i,n){super(e);s(this,"camera");s(this,"_customInput");const a=new g(2.2,1.6,-1);i&&(a.x=i.x,a.z=i.z),this.camera=new Vi("gyro",a,this.scene),this.camera.inputs.removeByType("FreeCameraDeviceOrientationInput"),this._customInput=new ki(n),this.camera.addCustomInput(this._customInput),this.camera.fov=1.2,this.camera.inertia=0,this.camera.minZ=.1,this.camera.attachControl(void 0,!0),this.camera.enableHorizontalDragging(-2/300)}async getGyroAngles(){return this._customInput.getGyroAngles()}babylonCamera(){return this.camera}moveToPosition(e,i){e&&(this.camera.position=new g(e.x,1.6,e.z),i&&(this.camera.target=this.camera.position.add(i.normalize())))}}class Ft extends F{constructor(e){super(e);s(this,"camera");s(this,"cameraTypeSetting",H.AllEach);s(this,"defaultLowerBetaLimit",2*R);s(this,"defaultUpperBetaLimit",90*R);s(this,"panSpeedAdjust",2);s(this,"rotationSpeedAdjust",2);s(this,"zoomSpeedAdjust",0);s(this,"alphaStart",0);const i=!0,n=!0,a=!0;e.createDefaultCamera(i,n,a),this.camera=this.scene.activeCamera,this.initializeArcRotateCamera()}initializeArcRotateCamera(){this.setDefault(),this.setCameraLimits(),this.camera.inertia=.3,this.camera.panningInertia=.3;const e=this.createPointersInput();this.camera.inputs.removeByType("ArcRotateCameraPointersInput"),this.camera.inputs.add(e),this.applyCameraSpeed(),this.camera.minZ=.05,this.camera.onViewMatrixChangedObservable.add((i,n)=>{i instanceof Ae&&(i.minZ=i.radius*.005,i.radius>20&&(i.minZ+=.1),i.minZ=Math.max(i.minZ,.05))})}babylonCamera(){return this.camera}initWithExtends(e,i=!0,n=.3){this.ext=e,this.defaultTarget.x=(e.min.x+e.max.x)*.5,this.defaultTarget.y=e.min.y,this.defaultTarget.z=(e.min.z+e.max.z)*.5;const a=k(this.scene,e,this.camera);if(!a)return;const o=i?this.defaultAlpha:this.camera.alpha,l=i?this.defaultBeta:this.camera.beta;this.animationHelper.moveAnimation(this.camera,this.defaultTarget,o,l,a,n)}setSceneEvents(){const e=this.scene,i=this.camera,n=this.fitRadiusWithMargin,a=this.zoomInToPoint,o=this.restoreCameraWithRotationHold,l=()=>b.RenderUpdate();e.onPointerObservable.add(c=>{var h,m;switch(c.type){case L.POINTERDOUBLETAP:(h=c.pickInfo)!=null&&h.pickedPoint&&(i.radius>=n*.95?a(i,(m=c.pickInfo)==null?void 0:m.pickedPoint):o(i));break;case L.POINTERWHEEL:l();break}})}setDefault(){this.camera.target=this.defaultTarget,this.camera.radius=this.defaultRadius,this.camera.alpha=this.defaultAlpha,this.camera.beta=this.defaultBeta,this.camera.fov=this.defaultFov}topFit(e){this.camera.target=this.defaultTarget,this.camera.alpha=this.defaultAlpha,this.camera.beta=this.defaultBeta,this.camera.fov=this.defaultFov,this.zoomFit(!0,e)}setCameraType(e){this.cameraTypeSetting=e}setCameraSpeedOption(e,i,n){this.panSpeedAdjust=e,this.rotationSpeedAdjust=i,this.zoomSpeedAdjust=n,this.applyCameraSpeed()}applyCameraSpeed(){this.camera.panningSensibility=150*Math.pow(.7,this.panSpeedAdjust),this.camera.pinchPrecision=36*Math.pow(.7,this.zoomSpeedAdjust),this.camera.angularSensibilityX=500*Math.pow(.7,this.rotationSpeedAdjust),this.camera.angularSensibilityY=500*Math.pow(.7,this.rotationSpeedAdjust)}setCameraLimits(e=!0){this.camera.lowerBetaLimit=e?this.defaultLowerBetaLimit:null,this.camera.upperBetaLimit=e?this.defaultUpperBetaLimit:null,this.camera.lowerRadiusLimit=e?F.minDistance:null}setMinMaxDistance(e){e.min!==void 0&&(F.minDistance=e.min,this.camera.lowerRadiusLimit=e.min),e.max!==void 0&&(F.maxDistance=e.max,this.camera.upperRadiusLimit=e.max)}recoverMinMaxDistance(){this.setMinMaxDistance({min:F.minDistance,max:F.maxDistance})}setCameraValue(e){this.initializeArcRotateCamera();const i=k(this.scene,e,this.camera);if(i!==void 0)this.camera.upperRadiusLimit=i*1.5,this.fitRadiusWithMargin=i;else throw new Error("Fail to get fitRadius in setCameraValue")}createPointersInput(){const e=new We;e.checkIsPanPossible=(n,a)=>Or(n,a,this.scene,this.camera);const i=this.cameraTypeSetting;return i===H.PanZoom||i===H.PanRotate?(e.swapPanAndRotate=!0,e.multiTouchPanAndZoom=!1,i===H.PanZoom?(e.multiTouchPanning=!1,e.pinchZoom=!0):(e.multiTouchPanning=!0,e.pinchZoom=!1)):i===H.RotateZoom||i===H.RotatePan?(e.swapPanAndRotate=!1,e.multiTouchPanAndZoom=!1,i===H.RotateZoom?(e.multiTouchPanning=!1,e.pinchZoom=!0):(e.multiTouchPanning=!0,e.pinchZoom=!1)):(i===H.AllAll||i===H.AllEach)&&(e.swapPanAndRotate=!1,e.multiTouchPanAndZoom=i===H.AllAll,e.multiTouchPanning=!0,e.pinchZoom=!0),e}isRemainInertia(){return this.camera.inertialAlphaOffset!==0||this.camera.inertialBetaOffset!==0||this.camera.inertialPanningX!==0||this.camera.inertialPanningY!==0}rotateLeft(e){this.rotateCommon(e,!1)}rotateRight(e){this.rotateCommon(e,!0)}quaterView(e=45,i=45,n){const a=e*R,o=i*R,l=this.fitRadiusWithMargin;this.animationHelper.moveAnimation(this.camera,this.defaultTarget,a,o,l,n)}rotateCommon(e,i){e.target=this.defaultTarget,e.radius=this.fitRadiusWithMargin,e.beta=45*R,this.alphaStart===0&&(this.alphaStart=e.alpha);let n=this.getNextRotationAlpha(this.alphaStart,i);this.animationHelper.changeAlphaWithAnimation(this.alphaStart,n,e),this.alphaStart=n}getNextRotationAlpha(e,i){const n=lt*e,a=Math.round(n),o=a%90===45||a%90===-45;let l=45;return o&&(l=i?n+90:n-90),R*l}restoreCameraWithRotationHold(e){this.animationHelper.zoomAnimation(e,this.fitRadiusWithMargin,this.defaultTarget,.1)}zoomInToPoint(e,i){if(e.radius<=0)return;const n=.4,a=this.fitRadiusWithMargin*n/e.radius,l=i.subtract(e.target).multiplyByFloats(1-a,1-a,1-a),c=e.target.add(l),h=e.radius*a;this.animationHelper.zoomAnimation(e,h,c,3)}zoomIn(e=30,i=.3){if(e<0)return;const n=this.camera.radius*(1-e/100);this.animationHelper.zoomAnimation(this.camera,n,this.camera.target,i)}zoomOut(e=30,i=.3){if(e<0)return;const n=this.camera.radius*(1+e/100);this.animationHelper.zoomAnimation(this.camera,n,this.camera.target,i)}setDistance(e=3,i=.3){this.animationHelper.zoomAnimation(this.camera,e,this.camera.target,i)}zoomFitOnInit(e){const i=k(this.scene,e,this.camera);i!==void 0&&(this.fitRadiusWithMargin=i,this.setCameraValue(e),this.setSceneEvents(),this.animationHelper.zoomAnimation(this.camera,i,this.defaultTarget,1.5,!0))}zoomFit(e=!1,i){const n=k(this.scene,i,this.camera);n!==void 0&&(this.fitRadiusWithMargin=n,e?this.animationHelper.zoomAnimation(this.camera,n,this.defaultTarget,.4):this.camera.radius=n)}async moveTo(e,i,n=!1,a=1){let o=new g(0,0,-1);n&&(o=V.convertToVectorFromAlphaBetaRadian(this.camera.alpha,this.camera.beta));const[l,c]=i.getRotatedAlphaBetaAsRadianFrom(o),h=V.convertToVectorFromAlphaBetaRadian(l,c),m=new g(-e.x,e.h,-e.y);let d=this.camera.target.clone(),f=this.camera.position.clone();e.isRelative?(d=d.add(m),f=d.subtract(h)):(d=m.add(h),f=d.subtract(h));const u=g.Distance(f,d);this.changeCameraLimitRadiusAndUpperBeta(u,c),await this.animationHelper.moveAnimation(this.camera,d,l,c,1,a)}async moveToCameraTarget(e,i,n,a,o=1,l=!0){const c=l?i.clone().normalize().scale(-1):new g(0,0,-1),[h,m]=n.getRotatedAlphaBetaAsRadianFrom(c),d=e;this.changeCameraLimitRadiusAndUpperBeta(a,m),await this.animationHelper.moveAnimation(this.camera,d,h,m,a,o)}async moveToCoordinate(e,i,n=1){const a=i.clone();a.z=0;const{target:o,alpha:l,beta:c,radius:h}=Li(this.scene,e,a,1);await this.animationHelper.moveAnimation(this.camera,o,l,c,h,n)}changeCameraLimitRadiusAndUpperBeta(e,i){this.camera.lowerRadiusLimit&&e<this.camera.lowerRadiusLimit&&(this.camera.lowerRadiusLimit=e,F.minDistance=e),this.camera.upperRadiusLimit&&e>this.camera.upperRadiusLimit&&(this.camera.upperRadiusLimit=e,F.maxDistance=e)}topViewFit(e=.3,i){const n=this.defaultTarget,a=k(this.scene,i,this.camera);a!==void 0&&this.animationHelper.moveAnimation(this.camera,n,this.defaultAlpha,this.defaultBeta,a,e)}topViewCustom(e,i,n,a,o=.3,l){if(n<=0)return;const c=this.defaultTarget,h=new g(c.x-e,c.y,c.z-i),m=k(this.scene,l,this.camera);if(m===void 0)return;const d=1+(100-n)/100;this.animationHelper.moveAnimation(this.camera,h,this.defaultAlpha+a*R,this.defaultBeta,m*d,o)}setViewport(e){Object.assign(this.camera.viewport,e)}getViewport(){return this.camera.viewport}transformViewport(e,i,n,a){this.animationHelper.viewportAnimation(this.camera,e,i,n,a)}enableControl(e){if(this.camera.inputs.removeByType("ArcRotateCameraPointersInput"),e){const i=this.createPointersInput();this.camera.inputs.add(i),this.applyCameraSpeed()}}}var I=(r=>(r[r.ArcRotate=0]="ArcRotate",r[r.Free=1]="Free",r[r.Gyro=2]="Gyro",r))(I||{});const Hr="_wrapper_1mrf8_1",Ur="_canvas_1mrf8_21",Vr="_full_1mrf8_33",kr="_gui_1mrf8_51",Dt={wrapper:Hr,canvas:Ur,full:Vr,gui:kr},S=class{};let Re=S;s(Re,"pointMap",new Map),s(Re,"prevDist",-1),s(Re,"processPinch",(t,e)=>{if(t.type===L.POINTERDOWN&&(S.pointMap.set(t.event.pointerId,new ae(t.event.clientX,t.event.clientY)),S.pointMap.size===2)){const i=Array.from(S.pointMap.values());S.prevDist=ae.Distance(i[0],i[1])}if(t.type===L.POINTERUP&&(t.event.pointerId,S.pointMap.clear(),S.prevDist=-1,e.enableHorizontalDragging(-2/300)),t.type===L.POINTERMOVE&&(S.pointMap.set(t.event.pointerId,new ae(t.event.clientX,t.event.clientY)),S.pointMap.size===2)){e.enableHorizontalDragging(0);const i=Array.from(S.pointMap.values()),n=ae.Distance(i[0],i[1]);if(S.prevDist!==-1){const a=n-S.prevDist,o=e.target.subtract(e.position),l=new g(o.x*(a*.01),0,o.z*(a*.01));return e.position=e.position.add(l),e.target=e.target.add(l),S.prevDist=n,!0}else S.prevDist=n}return!1});const me=class{};let Le=me;s(Le,"pointMapDrag",new Map),s(Le,"processVerticalDrag",(t,e,i=!1)=>{if(t.type===L.POINTERDOWN&&(me.pointMapDrag.set(t.event.pointerId,new ae(t.event.clientX,t.event.clientY)),e.enableHorizontalDragging(-2/300)),t.type===L.POINTERUP&&(t.event.pointerId,me.pointMapDrag.clear(),e.enableHorizontalDragging(-2/300)),t.type===L.POINTERMOVE&&me.pointMapDrag.size===1){const n=Array.from(me.pointMapDrag.values()),a=new ae(n[0].x,n[0].y),o=new ae(t.event.clientX,t.event.clientY);me.pointMapDrag.set(t.event.pointerId,new ae(t.event.clientX,t.event.clientY));const l=Math.abs(o.y-a.y)>Math.abs(o.x-a.x);if(l){const c=o.y-a.y,h=e.target.subtract(e.position),m=new g(h.x*(c*.01),0,h.z*(c*.01));return e.position=e.position.add(m),e.target=e.target.add(m),!0}if(i&&!l){const c=o.x-a.x,h=e.target.subtract(e.position);h.applyRotationQuaternionInPlace(W.RotationAxis(g.Up(),-c*.003));const m=e.position.clone();e.target=m.add(h)}}return!1});class Wr{constructor(t){s(this,"engine");s(this,"scene");s(this,"zedcamera");s(this,"renderManager");s(this,"systemManager");s(this,"gizmoManager");s(this,"materialPluginManager");s(this,"camera");s(this,"furniture");s(this,"graphic");s(this,"observer");s(this,"performance");s(this,"initialize",()=>{O.start("Initialize"),this.engine=new Fn(this.canvasOrContext,!0,{adaptToDeviceRatio:!0}),this.engine.disableUniformBuffers=!0,this.scene=new Dn(this.engine),this.scene.clearColor=new Be(0,0,0,0),this.scene.autoClear=!1,this.scene.autoClearDepthAndStencil=!1,this.scene.skipFrustumClipping=!0,this.scene.skipPointerMovePicking=!0,this.scene.blockMaterialDirtyMechanism=!0,this.scene.getEngine().stopRenderLoop(),this.gizmoManager=new zn(this.scene),this.gizmoManager.enableAutoPicking=!1,this.gizmoManager.onAttachedToNodeObservable.add(t=>{const e=!!t;this.gizmoManager.positionGizmoEnabled=e,this.gizmoManager.rotationGizmoEnabled=e,this.gizmoManager.gizmos.positionGizmo&&(this.gizmoManager.gizmos.positionGizmo.yGizmo.isEnabled=!1,this.gizmoManager.gizmos.positionGizmo.scaleRatio=.8),this.gizmoManager.gizmos.rotationGizmo&&(this.gizmoManager.gizmos.rotationGizmo.xGizmo.isEnabled=!1,this.gizmoManager.gizmos.rotationGizmo.zGizmo.isEnabled=!1,this.gizmoManager.gizmos.rotationGizmo.scaleRatio=.5)}),this.observer=new z,this.materialPluginManager=new ye,this.zedcamera=new Ft(this.scene),this.renderManager=new b(this.scene,this.engine,this.gizmoManager,this.canvasOrContext instanceof HTMLCanvasElement?this.canvasOrContext:void 0),this.systemManager=new yr(this.scene),this.camera=new yi(this.engine,this.scene,this.zedcamera),this.furniture=new vr(this.gizmoManager),this.graphic=new br,this.performance=Me.getInstance(this.scene),this.observer.onAllModelLoaded.add(()=>{this.setActiveHome(this.activeHomeId)}),O.end("Initialize")});s(this,"dispose",()=>{O.reset(),p.clear(),Br(),this.observer.reset(),this.materialPluginManager.reset(),this.graphic.dispose(),this.renderManager.reset(),this.zedcamera.reset(),this.gizmoManager.dispose(),this.systemManager.reset(),this.scene.clearCachedVertexData(),this.scene.cleanCachedTextureBuffer(),this.scene.dispose(),this.engine.dispose()});s(this,"changeCamera",t=>{if(this.getCameraType()===t)return;let i;switch(t){case I.Free:i=new wi(this.scene);break;case I.ArcRotate:i=new Ft(this.scene),i.recoverMinMaxDistance();break;case I.Gyro:const n=this.zedcamera.babylonCamera(),a=n.target.subtract(n.position);i=new It(this.scene,n.position,a);break;default:throw new Error("impossible camera type.")}i.copyFromCamera(this.zedcamera),this.changeZedCamera(i),this.clearGyroCallbacks(),t===I.Gyro&&this.scene.onPointerObservable.add(this.onTouchInGyro),this.renderManager.runRenderLoop(!0)});s(this,"getCameraType",()=>{if(this.zedcamera instanceof Ft)return I.ArcRotate;if(this.zedcamera instanceof wi)return I.Free;if(this.zedcamera instanceof It)return I.Gyro;throw new Error("impossible camera type.")});s(this,"gyroTransitionAnimationSeconds",.7);s(this,"isGyroSupported",!0);s(this,"startTopViewForGyro",t=>{t!==void 0&&(this.gyroTransitionAnimationSeconds=t),this.getCameraType()!==I.ArcRotate&&this.changeCamera(I.ArcRotate),this.scene.onPointerObservable.add(this.onTouchInTopView),this.camera.topViewFit()});s(this,"endGyro",()=>{this.changeCamera(I.ArcRotate)});s(this,"moveToGyroPosition",async(t,e,i)=>{if(this.getCameraType()===I.Gyro)return;i!==void 0&&(this.gyroTransitionAnimationSeconds=i);const n=this.gyroTransitionAnimationSeconds,a=t||new g(0,1.6,0),o=e||xr(a,Er()),l=new It(this.scene,a,o),c=l.babylonCamera();if(this.isGyroSupported){const d=l.getGyroAngles(),f=new Promise(v=>setTimeout(v,2e3,void 0));await Promise.any([d,f])===void 0&&(this.isGyroSupported=!1)}this.changeCamera(I.Free);const h=this.zedcamera.babylonCamera(),m=h.target.subtract(h.position).normalize();return h.target=h.position.add(m),h.rotation.y<0&&(h.rotation.y+=360*R),this.isGyroSupported||(c.position=a,c.position.y=1.6,c.setTarget(c.position.add(o)),c.inputs.removeByType("FreeCameraMouseInput")),Ui.toOtherCameraState(h,c,this.scene,n),new Promise(d=>setTimeout(d,n*1e3*1.1,void 0))});s(this,"onTouchInTopView",t=>{const e=t.pickInfo&&t.pickInfo.pickedPoint?t.pickInfo.pickedPoint:void 0;t.type===L.POINTERTAP&&this.moveToGyroPosition(e).then(()=>{this.changeCamera(I.Gyro)})});s(this,"onTouchInGyro",t=>{const e=this.zedcamera.babylonCamera();if(Re.processPinch(t,e))return;const i=this.isGyroSupported===!1;Le.processVerticalDrag(t,e,i),t.type===L.POINTERTAP||t.type===L.POINTERDOUBLETAP&&this.startTopViewForGyro()});s(this,"clearGyroCallbacks",()=>{this.scene.onPointerObservable.removeCallback(this.onTouchInTopView),this.scene.onPointerObservable.removeCallback(this.onTouchInGyro)});s(this,"changeZedCamera",t=>{const e=this.zedcamera;this.camera=new yi(this.engine,this.scene,t),this.graphic.replaceCamera(e.babylonCamera(),t.babylonCamera()),this.zedcamera=t,this.zedcamera.setActive()});s(this,"defalutQualitySettings",{simpleMode:!1,modelLOD:"LOD0",textureMaxSize:"2048",resolution:de.p900,reflection:!1,useNormalTexture:!1});s(this,"loadHome",async(t,e)=>{this.activeHomeId=t,e===void 0&&(e=this.defalutQualitySettings),e.reflection===void 0&&(e.reflection=this.defalutQualitySettings.reflection),e.resolution===void 0&&(e.resolution=this.defalutQualitySettings.resolution),e.useNormalTexture===void 0&&(e.useNormalTexture=this.defalutQualitySettings.useNormalTexture),b.SetResolution(e.resolution),O.start("Load Home"),await _r(this.scene,t,this.graphic,e),O.end("Load Home"),this.performance.loadHomeTotal=O.get("Load Home")??0,O.print(),O.reset()});s(this,"activeHomeId","");s(this,"setActiveHome",(t,e=!0)=>{this.activeHomeId=t,Ce.setActiveHome(t),e?this.activeFloorplanEntities.length>0&&this.camera.setTargetFloor(this.activeFloorplanEntities[0].Identifier.floorplanId,!1):b.RenderUpdate()});this.canvasOrContext=t,this.initialize()}EnableDBStorage(t){Ln.IDBStorageEnabled=t}async saveCache(){const t=this.activeHomeId,e=be.getMaterialChangeableEntities(),i=Z[t];i&&(i.forEach(n=>{var c;const a=pe.getMovableTransformEntitiesInFloorplan(n.floorplanId),o=(c=se.getFloorplanEntity(n.floorplanId))==null?void 0:c.Floorplan;n.furniturePlaceData.forEach(h=>{const m=a.find(d=>d.TransformNode.name===h.name);if(m){const d=m.TransformNode,f=o?d.absolutePosition.subtract(o.pivotPosition):d.absolutePosition;d.rotationQuaternion&&(d.rotationQuaternion.toEulerAnglesToRef(d.rotation),d.rotationQuaternion=null);const u=$.FromRadians(Fi(d.rotation.y)).degrees(),v=Vt(d.scaling);h.position={x:f.x,y:f.y,z:f.z},h.rotationY=u,h.scale={x:v.x,y:v.y,z:v.z}}});const l=e.filter(h=>h.Identifier.floorplanId===n.floorplanId).flatMap(h=>h.MaterialChangeable.materialOverrideData);n.materialOverrideData=l,console.log(n)}),await Lt("User",`Zed_${t}.json`,i))}async deleteCache(){await Hn("User")}get activeFloorplanEntities(){return se.getFloorplanEntitiesInActiveHome()}getRooms(t){return oe.getRooms(t)}getRoomObjects(t){return oe.getRoomObjects(t)}getRoomObjectsOnlyThing(t){return oe.getRoomObjectsOnlyThing(t)}}const jr=Wr,Wi=Y.createContext(void 0);function ea(){return Y.useContext(Wi)}const Gr=Y.forwardRef(function({children:t,className:e,style:i,...n},a){const[o,l]=Y.useState(),[c,h]=Y.useState(null);return Y.useImperativeHandle(a,()=>o,[o]),Y.useEffect(()=>{l(c?new jr(c):void 0)},[c]),Y.useEffect(()=>{if(o)return()=>{o.dispose()}},[o]),Mt.jsxs("div",{className:[e,Dt.wrapper].join(" "),style:i,children:[Mt.jsx("canvas",{ref:h,className:[Dt.full,Dt.canvas].join(" "),...n}),Mt.jsx(Wi.Provider,{value:o,children:t})]})}),Ri=Y.memo(Gr);try{Ri.displayName="Zed",Ri.__docgenInfo={description:"Zigbang 3D for IoT",displayName:"Zed",props:{}}}catch{}export{Pr as A,I as C,ee as E,ye as M,de as R,Nn as S,Oe as T,Ri as Z,Jr as a,V as b,te as c,Sr as d,qr as e,Bn as f,Kr as g,Ze as h,b as i,Je as l,D as p,R as t,ea as u};
//# sourceMappingURL=ZEDComponent-126b9559.js.map
